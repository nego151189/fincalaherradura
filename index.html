=== filename: /index.html ===
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Finca La Herradura - Dashboard</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7CB342">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Finca La Herradura">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app">
        <!-- Header con estado de conexión -->
        <header class="header">
            <div class="header-content">
                <h1>🍋 Finca La Herradura</h1>
                <div id="connection-status" class="connection-status offline">
                    <span class="status-dot"></span>
                    <span class="status-text">Verificando...</span>
                </div>
            </div>
            <!-- En el header, después del connection-status -->
            <div id="sync-button-container" class="sync-container hidden">
                <button id="sync-now" class="btn-sync">
                    <span class="sync-icon">🔄</span>
                    Sincronizar Pendientes (<span id="pending-count">0</span>)
                </button>
            </div>
        </header>

        <!-- Botón de sincronización (solo visible si hay pendientes) -->
        <div id="sync-button-container" class="sync-container hidden">
            <button id="sync-now" class="btn-sync">
                <span class="sync-icon">🔄</span>
                Sincronizar Pendientes (<span id="pending-count">0</span>)
            </button>
        </div>

        <!-- Dashboard Stats -->
        <section class="dashboard-stats">
            <div class="stat-card primary">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                    <h3 id="produccion-hoy">Cargando...</h3>
                    <p>Producción Hoy</p>
                </div>
            </div>
            
            <div class="stat-card secondary">
                <div class="stat-icon">💧</div>
                <div class="stat-content">
                    <h3 id="tanque-nivel">Cargando...</h3>
                    <p>Tanque de Riego</p>
                </div>
            </div>
            
            <div class="stat-card tertiary">
                <div class="stat-icon">🌳</div>
                <div class="stat-content">
                    <h3 id="arboles-sanos">Cargando...</h3>
                    <p>Árboles Sanos</p>
                </div>
            </div>
        </section>

        <!-- Acciones Rápidas -->
        <section class="quick-actions">
            <h2>Acciones Rápidas</h2>
            <div class="action-buttons">
                <button onclick="location.href='produccion.html'" class="action-btn primary">
                    <div class="btn-icon">🍋</div>
                    <div class="btn-content">
                        <h3>Registrar Cosecha</h3>
                        <p>Producción diaria</p>
                    </div>
                </button>
                
                <button onclick="location.href='riegos.html'" class="action-btn secondary">
                    <div class="btn-icon">💧</div>
                    <div class="btn-content">
                        <h3>Control de Riego</h3>
                        <p>Gestión del agua</p>
                    </div>
                </button>
                
                <button onclick="location.href='arboles.html'" class="action-btn tertiary">
                    <div class="btn-icon">🌳</div>
                    <div class="btn-content">
                        <h3>Gestión Árboles</h3>
                        <p>Estado y ubicación</p>
                    </div>
                </button>
            </div>
        </section>

        <!-- Resumen del Día -->
        <section class="daily-summary">
            <h2>Resumen del Día</h2>
            <div class="summary-content">
                <div class="summary-item">
                    <span class="summary-label">Última cosecha:</span>
                    <span id="ultima-cosecha">--:--</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Último riego:</span>
                    <span id="ultimo-riego">--:--</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Trabajador activo:</span>
                    <span id="trabajador-activo">Ninguno</span>
                </div>
            </div>
        </section>

        <!-- Navegación inferior -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item active">
                <span class="nav-icon">🏠</span>
                <span class="nav-label">Inicio</span>
            </a>
            <a href="produccion.html" class="nav-item">
                <span class="nav-icon">🍋</span>
                <span class="nav-label">Cosecha</span>
            </a>
            <a href="riegos.html" class="nav-item">
                <span class="nav-icon">💧</span>
                <span class="nav-label">Riego</span>
            </a>
            <a href="arboles.html" class="nav-item">
                <span class="nav-icon">🌳</span>
                <span class="nav-label">Árboles</span>
            </a>
        </nav>
    </div>

    <!-- Loading overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
    
    <!-- Scripts de la app -->
    <script src="js/firebase-config.js"></script>
    <script src="js/offline.js"></script>
    <script src="js/auth.js"></script>
    
<script>
    // Inicializar dashboard al cargar
    document.addEventListener('DOMContentLoaded', async function() {
        // Verificar autenticación
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                // Auto-login anónimo para simplicidad
                await firebase.auth().signInAnonymously();
            }
            
            // Cargar datos del dashboard
            await loadDashboardData();
            
            // Ocultar loading
            document.getElementById('loading').style.display = 'none';
        });
        
        // Configurar botón de sincronización
        document.getElementById('sync-now').addEventListener('click', function() {
            if (typeof syncPendingData === 'function') {
                syncPendingData();
            }
        });
        
        // Actualizar contador de pendientes cada 5 segundos
        setInterval(updatePendingCounter, 5000);
        updatePendingCounter(); // Inicializar
    });
    
    // FUNCIÓN FALTANTE - Agregar esto
    function updatePendingCounter() {
        if (window.offline && typeof window.offline.getPendingCount === 'function') {
            const count = window.offline.getPendingCount();
            const badge = document.getElementById('pending-count');
            const syncContainer = document.getElementById('sync-button-container');
            
            if (badge && syncContainer) {
                badge.textContent = count;
                if (count > 0) {
                    syncContainer.classList.remove('hidden');
                } else {
                    syncContainer.classList.add('hidden');
                }
            }
        }
    }
    
    async function loadDashboardData() {
        try {
            const db = firebase.firestore();
            const today = new Date().toISOString().split('T')[0];
            
            // Cargar producción del día
            const cosechasRef = db.collection('cosechas_diarias');
            const cosechasHoy = await cosechasRef.where('fecha', '==', today).get();
            let totalProduccion = 0;
            let ultimaCosecha = '--:--';
            
            if (!cosechasHoy.empty) {
                cosechasHoy.forEach(doc => {
                    const data = doc.data();
                    totalProduccion += (data.primera || 0) + (data.segunda || 0) + (data.descarte || 0);
                    if (data.timestamp) {
                        const hora = new Date(data.timestamp.toDate()).toLocaleTimeString('es-GT', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        if (ultimaCosecha === '--:--' || data.timestamp.toDate() > new Date(ultimaCosecha)) {
                            ultimaCosecha = hora;
                        }
                    }
                });
            }
            
            document.getElementById('produccion-hoy').textContent = totalProduccion + ' limones';
            document.getElementById('ultima-cosecha').textContent = ultimaCosecha;
            
            // Cargar nivel del tanque (último registro)
            const riegosRef = db.collection('riegos');
            const ultimoRiego = await riegosRef.orderBy('timestamp', 'desc').limit(1).get();
            
            let nivelTanque = '25,000L';
            let ultimoRiegoHora = '--:--';
            
            if (!ultimoRiego.empty) {
                const data = ultimoRiego.docs[0].data();
                nivelTanque = (data.nivel_tanque || 25000).toLocaleString() + 'L';
                if (data.timestamp) {
                    ultimoRiegoHora = new Date(data.timestamp.toDate()).toLocaleTimeString('es-GT', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            }
            
            document.getElementById('tanque-nivel').textContent = nivelTanque;
            document.getElementById('ultimo-riego').textContent = ultimoRiegoHora;
            
            // Contar árboles sanos
            const arbolesRef = db.collection('arboles');
            const arbolesSanos = await arbolesRef.where('estado_salud', '==', 'sano').get();
            document.getElementById('arboles-sanos').textContent = arbolesSanos.size + ' de 800';
            
        } catch (error) {
            console.error('Error cargando dashboard:', error);
            // Mostrar datos offline si están disponibles
            loadOfflineDashboardData();
        }
    }
    
    function loadOfflineDashboardData() {
        // Cargar datos básicos desde localStorage si no hay conexión
        const offlineData = localStorage.getItem('dashboard_offline');
        if (offlineData) {
            const data = JSON.parse(offlineData);
            document.getElementById('produccion-hoy').textContent = data.produccion || '0 limones';
            document.getElementById('tanque-nivel').textContent = data.tanque || '25,000L';
            document.getElementById('arboles-sanos').textContent = data.arboles || '800 de 800';
        }
    }
    
    // Registrar Service Worker
// En tu index.html, modifica la línea donde registras el SW:
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
        .then(registration => {
            registration.update(); // Forzar actualización
            console.log('SW registrado:', registration.scope);
        })
        .catch(error => console.error('SW falló:', error));
}
</script>
</body>
</html>

