<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FincaLimón - Gestión Agrícola</title>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- CSS Personalizados -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/components.css">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50 font-sans antialiased">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center mx-auto mb-4 animate-pulse">
                <i data-lucide="tree-pine" class="h-8 w-8 text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">FincaLimón</h2>
            <p class="text-gray-600 mb-4">Cargando aplicación...</p>
            <div class="w-32 h-2 bg-gray-200 rounded-full mx-auto">
                <div class="h-2 bg-green-500 rounded-full animate-pulse" style="width: 60%"></div>
            </div>
            <!-- Indicador de estado de Firebase -->
            <div id="firebase-status" class="mt-4 text-sm text-gray-500">
                <span id="firebase-indicator" class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                <span>Conectando a Firebase...</span>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen flex" style="display: none;">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-white shadow-xl transition-all duration-300 relative">
            <!-- Sidebar Header -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="tree-pine" class="h-6 w-6 text-white"></i>
                    </div>
                    <div class="sidebar-text">
                        <h1 class="font-bold text-xl text-gray-800">FincaLimón</h1>
                        <p class="text-sm text-gray-500">Gestión Agrícola</p>
                    </div>
                </div>
                
                <!-- Indicador de estado de conexión -->
                <div class="mt-2 flex items-center gap-2 text-xs">
                    <span id="connection-indicator" class="w-2 h-2 bg-green-500 rounded-full"></span>
                    <span id="connection-status">En línea</span>
                </div>
            </div>
            
            <!-- Navigation Menu -->
            <nav class="p-4 space-y-2">
                <button data-section="dashboard" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors active">
                    <i data-lucide="home" class="h-5 w-5"></i>
                    <span class="sidebar-text font-medium">Panel Principal</span>
                </button>
                
                <button data-section="trees" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors">
                    <i data-lucide="tree-pine" class="h-5 w-5"></i>
                    <span class="sidebar-text font-medium">Árboles</span>
                </button>
                
                <button data-section="harvest" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors">
                    <i data-lucide="scissors" class="h-5 w-5"></i>
                    <span class="sidebar-text font-medium">Cosechas</span>
                </button>
                
                <button data-section="fertilizer" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors">
                    <i data-lucide="droplets" class="h-5 w-5"></i>
                    <span class="sidebar-text font-medium">Abonos</span>
                </button>
                
                <button data-section="spray" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors">
                    <i data-lucide="bug" class="h-5 w-5"></i>
                    <span class="sidebar-text font-medium">Fumigaciones</span>
                </button>
                
                <button data-section="analytics" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors">
                    <i data-lucide="bar-chart-3" class="h-5 w-5"></i>
                    <span class="sidebar-text font-medium">Productividad</span>
                </button>
                
                <button data-section="map" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors">
                    <i data-lucide="map-pin" class="h-5 w-5"></i>
                    <span class="sidebar-text font-medium">Mapa GPS</span>
                </button>
                
                <button data-section="calendar" class="nav-item w-full flex items-center gap-3 p-3 rounded-lg transition-colors">
                    <i data-lucide="calendar" class="h-5 w-5"></i>
                    <span class="sidebar-text font-medium">Calendario</span>
                </button>
            </nav>
            
            <!-- Sidebar Toggle Button -->
            <button id="sidebar-toggle" class="absolute -right-3 top-20 bg-white border-2 border-gray-200 rounded-full p-1 hover:bg-gray-50 transition-colors">
                <i data-lucide="menu" class="h-4 w-4"></i>
            </button>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-hidden">
            <!-- Top Header -->
            <header class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="page-title" class="text-2xl font-bold text-gray-800">Panel Principal</h2>
                        <p id="page-subtitle" class="text-sm text-gray-600">Resumen general de tu finca de limones</p>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <!-- Weather Widget -->
                        <div class="hidden md:flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg">
                            <i data-lucide="sun" class="h-5 w-5 text-blue-600"></i>
                            <span class="text-sm font-medium text-blue-800">24°C - Soleado</span>
                        </div>
                        
                        <!-- Sync Status -->
                        <div id="sync-status" class="hidden items-center gap-2 bg-green-50 px-3 py-2 rounded-lg">
                            <i data-lucide="refresh-cw" class="h-4 w-4 text-green-600"></i>
                            <span class="text-sm font-medium text-green-800">Sincronizado</span>
                        </div>
                        
                        <!-- Notifications -->
                        <button id="notifications-btn" class="relative p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                            <i data-lucide="bell" class="h-6 w-6"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">2</span>
                        </button>
                        
                        <!-- Settings -->
                        <button class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                            <i data-lucide="settings" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Page Content Container -->
            <div class="p-6 h-full overflow-y-auto">
                <div class="max-w-7xl mx-auto">
                    <!-- Dynamic Content Area -->
                    <div id="content-area">
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">🌿</div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Bienvenido a FincaLimón</h1>
                            <p class="text-gray-600">Tu sistema de gestión agrícola está listo</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <!-- Modal content will be inserted here -->
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-3">
        <!-- Toast notifications will appear here -->
    </div>

    <!-- Firebase Manager Script (debe cargarse antes que el resto) -->
    <script type="module">
        // ... (código de Firebase sin cambios) ...
    </script>

    <script>
        // === CONSTANTS.JS (SIN EXPORT) ===
        const STORAGE_KEYS = {
            TREES: 'fincalimon_trees',
            ACTIVITIES: 'fincalimon_activities',
            HARVESTS: 'fincalimon_harvests',
            USER_SETTINGS: 'fincalimon_settings',
            PRODUCTS: 'fincalimon_products',
            CALENDAR_EVENTS: 'fincalimon_calendar',
            SECTOR_PRODUCTIVITY: 'fincalimon_sector_productivity'
        };

        const ROUTES = {
            dashboard: { name: 'dashboard', title: 'Panel Principal' },
            trees: { name: 'trees', title: 'Árboles' }, 
            activities: { name: 'activities', title: 'Actividades' },
            harvest: { name: 'harvest', title: 'Cosechas' },
            fertilizer: { name: 'fertilizer', title: 'Abonos' },
            spray: { name: 'spray', title: 'Fumigaciones' },
            analytics: { name: 'analytics', title: 'Productividad' },
            map: { name: 'map', title: 'Mapa GPS' },
            calendar: { name: 'calendar', title: 'Calendario' }
        };

        const APP_CONFIG = {
            name: 'FincaLimón',
            version: '1.0.0',
            description: 'Sistema de Gestión Agrícola'
        };

        // === HELPERS.JS (SIN EXPORT) ===
        const formatDate = (dateString, format = 'dd/mm/yyyy') => {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            
            switch (format) {
                case 'dd/mm/yyyy':
                    return `${day}/${month}/${year}`;
                case 'yyyy-mm-dd':
                    return `${year}-${month}-${day}`;
                default:
                    return `${day}/${month}/${year}`;
            }
        };

        const formatNumber = (number, decimals = 2) => {
            return Number(number).toFixed(decimals);
        };

        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };

        const showToast = (message, type = 'info', duration = 3000) => {
            const toastContainer = document.getElementById('toast-container');
            
            const toast = document.createElement('div');
            toast.className = `px-6 py-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            
            const colors = {
                success: 'bg-green-600 text-white',
                error: 'bg-red-600 text-white',
                warning: 'bg-yellow-600 text-white',
                info: 'bg-blue-600 text-white'
            };
            
            toast.className += ` ${colors[type]}`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <span>${message}</span>
                    <button class="ml-4 text-white hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
                        ×
                    </button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        };

        // === STORAGE.JS CON FIREBASE ===
        class StorageManager {
            constructor() {
                this.isLocalStorageAvailable = this.checkStorageAvailable();
                this.firebase = null;
                this.isFirebaseReady = false;
                
                // Esperar a que Firebase esté listo
                window.addEventListener('firebaseReady', () => {
                    this.firebase = window.firebaseManager;
                    this.isFirebaseReady = true;
                    console.log('💾 StorageManager conectado a Firebase');
                });
                
                if (!this.isLocalStorageAvailable) {
                    console.warn('⚠️ localStorage no disponible');
                }
            }

            checkStorageAvailable() {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // === MÉTODOS PARA ÁRBOLES ===
            async getTrees() {
                try {
                    if (this.isFirebaseReady) {
                        return await this.firebase.getTrees();
                    }
                    return this.getItem(STORAGE_KEYS.TREES, []);
                } catch (error) {
                    console.error('Error obteniendo árboles:', error);
                    return this.getItem(STORAGE_KEYS.TREES, []);
                }
            }

            async saveTrees(trees) {
                try {
                    let success = false;
                    
                    if (this.isFirebaseReady) {
                        success = await this.firebase.saveTrees(trees);
                    }
                    
                    if (this.isLocalStorageAvailable) {
                        this.setItem(STORAGE_KEYS.TREES, trees);
                        success = true;
                    }
                    
                    if (success) {
                        console.log(`💾 Guardados ${trees.length} árboles`);
                    }
                    
                    return success;
                } catch (error) {
                    console.error('Error guardando árboles:', error);
                    return false;
                }
            }

            async addTree(tree) {
                try {
                    if (this.isFirebaseReady) {
                        return await this.firebase.addTree(tree);
                    }
                    
                    const trees = await this.getTrees();
                    const newTree = {
                        ...tree,
                        id: tree.id || this.generateId(),
                        createdAt: tree.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    trees.push(newTree);
                    await this.saveTrees(trees);
                    return newTree;
                } catch (error) {
                    console.error('Error agregando árbol:', error);
                    throw error;
                }
            }

            async updateTree(treeId, updates) {
                try {
                    if (this.isFirebaseReady) {
                        return await this.firebase.updateTree(treeId, updates);
                    }
                    
                    const trees = await this.getTrees();
                    const index = trees.findIndex(tree => tree.id === treeId);
                    
                    if (index !== -1) {
                        trees[index] = {
                            ...trees[index],
                            ...updates,
                            updatedAt: new Date().toISOString()
                        };
                        await this.saveTrees(trees);
                        return trees[index];
                    }
                    return null;
                } catch (error) {
                    console.error('Error actualizando árbol:', error);
                    throw error;
                }
            }

            async deleteTree(treeId) {
                try {
                    if (this.isFirebaseReady) {
                        return await this.firebase.deleteTree(treeId);
                    }
                    
                    const trees = await this.getTrees();
                    const filteredTrees = trees.filter(tree => tree.id !== treeId);
                    
                    if (filteredTrees.length !== trees.length) {
                        await this.saveTrees(filteredTrees);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error eliminando árbol:', error);
                    throw error;
                }
            }

            // === MÉTODOS PARA COSECHAS ===
            async getHarvests() {
                try {
                    if (this.isFirebaseReady) {
                        // Implementar para Firebase si es necesario
                    }
                    return this.getItem(STORAGE_KEYS.HARVESTS, []);
                } catch (error) {
                    console.error('Error obteniendo cosechas:', error);
                    return this.getItem(STORAGE_KEYS.HARVESTS, []);
                }
            }

            async saveHarvests(harvests) {
                try {
                    if (this.isLocalStorageAvailable) {
                        this.setItem(STORAGE_KEYS.HARVESTS, harvests);
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error guardando cosechas:', error);
                    return false;
                }
            }

            async addHarvest(harvest) {
                try {
                    const harvests = await this.getHarvests();
                    const newHarvest = {
                        ...harvest,
                        id: harvest.id || this.generateId(),
                        date: harvest.date || new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    };
                    
                    harvests.push(newHarvest);
                    await this.saveHarvests(harvests);
                    
                    // Actualizar productividad del sector
                    await this.updateSectorProductivity(newHarvest.sector, newHarvest.quantity);
                    
                    return newHarvest;
                } catch (error) {
                    console.error('Error agregando cosecha:', error);
                    throw error;
                }
            }

            // === MÉTODOS PARA PRODUCTIVIDAD POR SECTOR ===
            async getSectorProductivity() {
                try {
                    return this.getItem(STORAGE_KEYS.SECTOR_PRODUCTIVITY, {});
                } catch (error) {
                    console.error('Error obteniendo productividad:', error);
                    return {};
                }
            }

            async updateSectorProductivity(sector, quantity) {
                try {
                    const productivity = await this.getSectorProductivity();
                    const currentDate = new Date().toISOString().split('T')[0]; // Fecha actual en YYYY-MM-DD
                    
                    if (!productivity[sector]) {
                        productivity[sector] = {
                            total: 0,
                            harvests: 0,
                            lastUpdated: currentDate,
                            history: {}
                        };
                    }
                    
                    // Actualizar total y conteo de cosechas
                    productivity[sector].total += quantity;
                    productivity[sector].harvests += 1;
                    productivity[sector].lastUpdated = currentDate;
                    
                    // Actualizar historial por fecha
                    if (!productivity[sector].history[currentDate]) {
                        productivity[sector].history[currentDate] = 0;
                    }
                    productivity[sector].history[currentDate] += quantity;
                    
                    // Guardar cambios
                    this.setItem(STORAGE_KEYS.SECTOR_PRODUCTIVITY, productivity);
                    
                    return productivity[sector];
                } catch (error) {
                    console.error('Error actualizando productividad:', error);
                    throw error;
                }
            }

            // === MÉTODOS GENÉRICOS PARA LOCALSTORAGE ===
            setItem(key, value) {
                if (!this.isLocalStorageAvailable) return false;
                
                try {
                    const serializedValue = JSON.stringify(value);
                    localStorage.setItem(key, serializedValue);
                    return true;
                } catch (error) {
                    console.error(`Error guardando ${key}:`, error);
                    return false;
                }
            }

            getItem(key, defaultValue = null) {
                if (!this.isLocalStorageAvailable) return defaultValue;
                
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error(`Error cargando ${key}:`, error);
                    return defaultValue;
                }
            }

            removeItem(key) {
                if (!this.isLocalStorageAvailable) return false;
                
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error(`Error eliminando ${key}:`, error);
                    return false;
                }
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // Estado de conexión
            isOnline() {
                return navigator.onLine && this.isFirebaseReady;
            }

            getConnectionStatus() {
                return {
                    online: navigator.onLine,
                    firebase: this.isFirebaseReady,
                    localStorage: this.isLocalStorageAvailable,
                    canSave: this.isFirebaseReady || this.isLocalStorageAvailable
                };
            }
        }

        // === MOCK DATA ===
        const mockData = {
            trees: [
                {
                    id: 'L001',
                    variety: 'Eureka',
                    plantedDate: '2020-03-15',
                    location: { 
                        sector: 'A1',
                        coordinates: { lat: 14.6349, lng: -90.5069 }
                    },
                    health: 'Excelente',
                    productivity: 85,
                    nextHarvest: 15,
                    notes: 'Árbol joven con buen desarrollo'
                },
                {
                    id: 'L002',
                    variety: 'Lisbon',
                    plantedDate: '2019-05-20',
                    location: { 
                        sector: 'A2',
                        coordinates: { lat: 14.6350, lng: -90.5070 }
                    },
                    health: 'Bueno',
                    productivity: 92,
                    nextHarvest: 8,
                    notes: 'Alta productividad, requiere poda'
                }
            ],
            activities: [
                {
                    id: generateId(),
                    type: 'cosecha',
                    date: new Date().toISOString().split('T')[0],
                    description: 'Cosecha matutina',
                    quantity: 150,
                    unit: 'kg'
                }
            ],
            harvests: [],
            userSettings: {
                theme: 'light',
                language: 'es',
                notifications: true
            }
        };

        function loadMockData() {
            return Promise.resolve(mockData);
        }

        // === COMPONENTES ===
        class Sidebar {
            constructor(options) {
                this.container = options.container;
                this.onNavigate = options.onNavigate;
                this.init();
            }

            init() {
                this.bindEvents();
            }

            bindEvents() {
                document.addEventListener('click', (e) => {
                    const navItem = e.target.closest('[data-section]');
                    if (navItem) {
                        e.preventDefault();
                        const route = navItem.dataset.section;
                        this.setActiveRoute(route);
                        if (this.onNavigate) {
                            this.onNavigate(route);
                        }
                    }
                });
            }

            setActiveRoute(route) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active', 'bg-green-100', 'text-green-600');
                    item.classList.add('text-gray-700', 'hover:bg-gray-100');
                });

                const activeItem = document.querySelector(`[data-section="${route}"]`);
                if (activeItem) {
                    activeItem.classList.remove('text-gray-700', 'hover:bg-gray-100');
                    activeItem.classList.add('active', 'bg-green-100', 'text-green-600');
                }
            }
        }

        class Dashboard {
            constructor(options) {
                this.container = options.container;
                this.data = options.data;
            }

            render() {
                const container = document.getElementById('content-area');
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm">Árboles Totales</p>
                                    <p class="text-2xl font-bold text-gray-800">${this.data.trees?.length || 0}</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="tree-pine" class="h-6 w-6 text-green-600"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm">Actividades Hoy</p>
                                    <p class="text-2xl font-bold text-gray-800">${this.data.activities?.length || 0}</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="activity" class="h-6 w-6 text-blue-600"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm">Productividad</p>
                                    <p class="text-2xl font-bold text-gray-800">87%</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="trending-up" class="h-6 w-6 text-yellow-600"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm">Cosecha del Mes</p>
                                    <p class="text-2xl font-bold text-gray-800">2,450 kg</p>
                                </div>
                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                    <i data-lucide="scissors" class="h-6 w-6 text-orange-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">Actividades Recientes</h3>
                        </div>
                        <div class="p-6">
                            <div class="text-center py-8 text-gray-500">
                                <i data-lucide="calendar" class="h-12 w-12 mx-auto mb-4 text-gray-400"></i>
                                <p>No hay actividades registradas</p>
                                <button class="quick-action-btn mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors" data-action="new-harvest">
                                    Agregar Actividad
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            updateData(newData) {
                this.data = newData;
                this.render();
            }
        }

        // === CLASE TREES MEJORADA ===
        class Trees {
            constructor(options = {}) {
                this.container = options.container || '#content-area';
                this.storage = window.StorageManager || null;
                this.currentFilter = 'all';
                this.currentSort = 'id';
                this.selectedTrees = new Set();
                this.init();
            }

            init() {
                this.bindEvents();
            }

            bindEvents() {
                // Usar event delegation para manejar clicks dinámicamente
                document.addEventListener('click', (e) => {
                    // LÍNEA CLAVE CORREGIDA - detectar tanto clase como ID
                    if (e.target.closest('.add-tree-btn') || e.target.closest('#add-tree-btn')) {
                        e.preventDefault();
                        console.log('🌳 Botón agregar árbol clickeado');
                        this.showAddTreeModal();
                        return;
                    }
                    
                    if (e.target.closest('.edit-tree-btn')) {
                        const treeId = e.target.closest('.edit-tree-btn').dataset.treeId;
                        this.showEditTreeModal(treeId);
                        return;
                    }
                    
                    if (e.target.closest('.delete-tree-btn')) {
                        const treeId = e.target.closest('.delete-tree-btn').dataset.treeId;
                        this.deleteTree(treeId);
                        return;
                    }
                    
                    if (e.target.closest('.filter-btn')) {
                        const filter = e.target.closest('.filter-btn').dataset.filter;
                        this.setFilter(filter);
                        return;
                    }
                    
                    if (e.target.closest('.tree-card')) {
                        const treeId = e.target.closest('.tree-card').dataset.treeId;
                        this.selectTree(treeId);
                        return;
                    }

                    // Botón para obtener ubicación GPS
                    if (e.target.closest('.get-gps-btn')) {
                        this.getGPSLocation();
                        return;
                    }
                });

                document.addEventListener('change', (e) => {
                    if (e.target.matches('#search-trees')) {
                        this.filterTrees(e.target.value);
                    }
                    
                    if (e.target.matches('.sort-select')) {
                        this.setSort(e.target.value);
                    }
                });
            }

            async getTreesData() {
                try {
                    if (this.storage) {
                        return await this.storage.getTrees();
                    }
                    
                    // Fallback a datos mock si no hay storage
                    return window.mockData?.trees || [];
                } catch (error) {
                    console.error('Error obteniendo árboles:', error);
                    return [];
                }
            }

            async render() {
                const trees = await this.getTreesData();
                
                return `
                    <div class="trees-container p-6">
                        <!-- Header -->
                        <div class="trees-header mb-8">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                                        <i data-lucide="tree-pine" class="mr-3"></i>
                                        Gestión de Árboles
                                    </h1>
                                    <p class="text-gray-600">Administra y monitorea todos tus árboles de limón</p>
                                </div>
                                <!-- BOTÓN CORREGIDO CON ID Y CLASE -->
                                <button id="add-tree-btn" class="add-tree-btn bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors mt-4 md:mt-0">
                                    <i data-lucide="plus" class="mr-2"></i>
                                    Agregar Árbol
                                </button>
                            </div>
                        </div>

                        <!-- Controles y Filtros -->
                        <div class="controls-section bg-white rounded-lg shadow-md p-6 mb-8">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Búsqueda -->
                                <div class="search-control">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Árbol</label>
                                    <div class="relative">
                                        <input type="text" 
                                               id="search-trees" 
                                               placeholder="Buscar por ID, variedad o sector..."
                                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <i data-lucide="search" class="absolute left-3 top-2.5 h-5 w-5 text-gray-400"></i>
                                    </div>
                                </div>

                                <!-- Filtros por Estado -->
                                <div class="filter-control">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Estado</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="filter-btn px-3 py-1 rounded-full text-sm font-medium border transition-colors ${this.currentFilter === 'all' ? 'bg-green-100 border-green-500 text-green-700' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}" 
                                                data-filter="all">Todos</button>
                                        <button class="filter-btn px-3 py-1 rounded-full text-sm font-medium border transition-colors ${this.currentFilter === 'excellent' ? 'bg-green-100 border-green-500 text-green-700' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}" 
                                                data-filter="excellent">Excelente</button>
                                        <button class="filter-btn px-3 py-1 rounded-full text-sm font-medium border transition-colors ${this.currentFilter === 'good' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}" 
                                                data-filter="good">Bueno</button>
                                        <button class="filter-btn px-3 py-1 rounded-full text-sm font-medium border transition-colors ${this.currentFilter === 'regular' ? 'bg-yellow-100 border-yellow-500 text-yellow-700' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}" 
                                                data-filter="regular">Regular</button>
                                        <button class="filter-btn px-3 py-1 rounded-full text-sm font-medium border transition-colors ${this.currentFilter === 'bad' ? 'bg-red-100 border-red-500 text-red-700' : 'border-gray-300 text-gray-700 hover:bg-gray-50'}" 
                                                data-filter="bad">Malo</button>
                                    </div>
                                </div>

                                <!-- Ordenar -->
                                <div class="sort-control">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ordenar por</label>
                                    <select class="sort-select w-full py-2 px-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="id">ID del Árbol</option>
                                        <option value="variety">Variedad</option>
                                        <option value="health">Estado de Salud</option>
                                        <option value="productivity">Productividad</option>
                                        <option value="location">Ubicación</option>
                                        <option value="nextHarvest">Próxima Cosecha</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Estadísticas Rápidas -->
                            <div class="quick-stats mt-6 pt-6 border-t border-gray-200">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    ${this.renderQuickStats(trees)}
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Árboles -->
                        <div class="trees-grid">
                            ${trees.length > 0 ? this.renderTreesGrid(trees) : this.renderEmptyState()}
                        </div>

                        <!-- Modal para Agregar/Editar Árbol -->
                        <div id="tree-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
                                ${this.renderTreeModal()}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderQuickStats(trees) {
                const stats = {
                    total: trees.length,
                    healthy: trees.filter(t => ['Excelente', 'Bueno'].includes(t.health)).length,
                    needsAttention: trees.filter(t => ['Regular', 'Malo'].includes(t.health)).length,
                    readyHarvest: trees.filter(t => t.nextHarvest <= 7).length
                };

                return `
                    <div class="stat-item text-center">
                        <p class="text-2xl font-bold text-green-600">${stats.total}</p>
                        <p class="text-sm text-gray-600">Total Árboles</p>
                    </div>
                    <div class="stat-item text-center">
                        <p class="text-2xl font-bold text-blue-600">${stats.healthy}</p>
                        <p class="text-sm text-gray-600">Saludables</p>
                    </div>
                    <div class="stat-item text-center">
                        <p class="text-2xl font-bold text-yellow-600">${stats.needsAttention}</p>
                        <p class="text-sm text-gray-600">Necesitan Atención</p>
                    </div>
                    <div class="stat-item text-center">
                        <p class="text-2xl font-bold text-orange-600">${stats.readyHarvest}</p>
                        <p class="text-sm text-gray-600">Listos Cosecha</p>
                    </div>
                `;
            }

            renderTreesGrid(trees) {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${trees.map(tree => this.renderTreeCard(tree)).join('')}
                    </div>
                `;
            }

            renderTreeCard(tree) {
                const healthColor = this.getHealthColor(tree.health);
                const productivityPercentage = (tree.productivity / 100) * 100;
                
                // Manejar coordenadas no definidas
                const lat = tree.location?.coordinates?.lat || 'N/A';
                const lng = tree.location?.coordinates?.lng || 'N/A';
                const coordinatesText = (lat !== 'N/A' && lng !== 'N/A') 
                    ? `${Number(lat).toFixed(6)}, ${Number(lng).toFixed(6)}`
                    : 'No definidas';
                
                return `
                    <div class="tree-card bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer border-l-4 border-${healthColor}-500"
                        data-tree-id="${tree.id}">
                        <div class="p-6">
                            <!-- Header del Árbol -->
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800">${tree.id}</h3>
                                <span class="health-badge bg-${healthColor}-100 text-${healthColor}-800 px-2 py-1 rounded-full text-xs font-medium">
                                    ${tree.health}
                                </span>
                            </div>

                            <!-- Información Básica -->
                            <div class="space-y-3 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <i data-lucide="sprout" class="h-4 w-4 mr-2"></i>
                                    <span>${tree.variety}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i data-lucide="map-pin" class="h-4 w-4 mr-2"></i>
                                    <span>Sector ${tree.location?.sector || 'N/A'}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i data-lucide="calendar" class="h-4 w-4 mr-2"></i>
                                    <span>Plantado: ${this.formatDate(tree.plantedDate)}</span>
                                </div>
                            </div>

                            <!-- Barra de Productividad -->
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">Productividad</span>
                                    <span class="text-sm text-gray-600">${tree.productivity}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-${healthColor}-500 h-2 rounded-full transition-all duration-300" 
                                        style="width: ${productivityPercentage}%"></div>
                                </div>
                            </div>

                            <!-- Próxima Cosecha -->
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Próxima Cosecha</span>
                                    <span class="text-sm font-semibold ${tree.nextHarvest <= 7 ? 'text-orange-600' : 'text-gray-600'}">
                                        ${tree.nextHarvest} días
                                    </span>
                                </div>
                            </div>

                            <!-- Coordenadas GPS -->
                            <div class="mb-4 text-xs text-gray-500">
                                <i data-lucide="map" class="h-3 w-3 mr-1"></i>
                                GPS: ${coordinatesText}
                            </div>

                            <!-- Acciones -->
                            <div class="flex space-x-2">
                                <button class="edit-tree-btn flex-1 bg-blue-50 text-blue-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors"
                                        data-tree-id="${tree.id}">
                                    <i data-lucide="edit-2" class="h-4 w-4 mr-1"></i>
                                    Editar
                                </button>
                                <button class="delete-tree-btn bg-red-50 text-red-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-100 transition-colors"
                                        data-tree-id="${tree.id}">
                                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderEmptyState() {
                return `
                    <div class="empty-state text-center py-16">
                        <div class="max-w-md mx-auto">
                            <i data-lucide="tree-pine" class="h-24 w-24 mx-auto text-gray-300 mb-6"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-4">No se encontraron árboles</h3>
                            <p class="text-gray-500 mb-8">Comienza agregando tu primer árbol de limón para gestionar tu finca.</p>
                            <button class="add-tree-btn bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                <i data-lucide="plus" class="mr-2"></i>
                                Agregar Primer Árbol
                            </button>
                        </div>
                    </div>
                `;
            }

            renderTreeModal() {
                return `
                    <div class="modal-header flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i data-lucide="tree-pine" class="mr-3"></i>
                            <span id="modal-title">Agregar Nuevo Árbol</span>
                        </h2>
                        <button class="modal-close text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="h-6 w-6"></i>
                        </button>
                    </div>

                    <form id="tree-form" class="space-y-6">
                        <input type="hidden" id="tree-id">
                        
                        <!-- Información Básica -->
                        <div class="form-section">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Información Básica</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ID del Árbol *</label>
                                    <input type="text" id="tree-code" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                           placeholder="Ej: L001">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Variedad *</label>
                                    <select id="tree-variety" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Seleccionar variedad</option>
                                        <option value="Eureka">Eureka</option>
                                        <option value="Lisbon">Lisbon</option>
                                        <option value="Meyer">Meyer</option>
                                        <option value="Ponderosa">Ponderosa</option>
                                        <option value="Femminello">Femminello</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Plantado *</label>
                                    <input type="date" id="planted-date" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado de Salud *</label>
                                    <select id="tree-health" required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Seleccionar estado</option>
                                        <option value="Excelente">Excelente</option>
                                        <option value="Bueno">Bueno</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Malo">Malo</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Ubicación -->
                        <div class="form-section">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Ubicación</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Sector *</label>
                                    <input type="text" id="tree-sector" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                           placeholder="Ej: A, B, C...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Latitud</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="tree-lat" step="any"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                               placeholder="14.123456">
                                        <button type="button" class="get-gps-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                                            <i data-lucide="map-pin" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Longitud</label>
                                    <div class="flex gap-2">
                                        <input type="number" id="tree-lng" step="any"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                               placeholder="-90.123456">
                                        <button type="button" class="get-gps-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                                            <i data-lucide="map-pin" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Productividad y Cosecha -->
                        <div class="form-section">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Productividad</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Productividad (%)</label>
                                    <input type="number" id="tree-productivity" min="0" max="100" value="75"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Porcentaje de productividad esperada</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Próxima Cosecha (días)</label>
                                    <input type="number" id="next-harvest" min="1" value="30"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">Días estimados para la próxima cosecha</p>
                                </div>
                            </div>
                        </div>

                        <!-- Notas -->
                        <div class="form-section">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notas Adicionales</label>
                            <textarea id="tree-notes" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                      placeholder="Observaciones especiales sobre el árbol..."></textarea>
                        </div>

                        <!-- Botones -->
                        <div class="modal-actions flex space-x-4 pt-6 border-t border-gray-200">
                            <button type="button" class="modal-close flex-1 bg-gray-200 text-gray-800 py-3 px-6 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                                <span id="submit-text">Guardar Árbol</span>
                            </button>
                        </div>
                    </form>
                `;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-GT');
            }

            // Métodos de filtrado y ordenamiento
            async getFilteredTrees() {
                let trees = await this.getTreesData();
                
                // Aplicar filtro de búsqueda
                const searchTerm = document.getElementById('search-trees')?.value?.toLowerCase() || '';
                if (searchTerm) {
                    trees = trees.filter(tree => 
                        tree.id.toLowerCase().includes(searchTerm) ||
                        tree.variety.toLowerCase().includes(searchTerm) ||
                        tree.location.sector.toLowerCase().includes(searchTerm)
                    );
                }

                // Aplicar filtro de estado
                if (this.currentFilter !== 'all') {
                    const healthMap = {
                        'excellent': 'Excelente',
                        'good': 'Bueno',
                        'regular': 'Regular',
                        'bad': 'Malo'
                    };
                    trees = trees.filter(tree => tree.health === healthMap[this.currentFilter]);
                }

                // Aplicar ordenamiento
                trees.sort((a, b) => {
                    switch (this.currentSort) {
                        case 'id':
                            return a.id.localeCompare(b.id);
                        case 'variety':
                            return a.variety.localeCompare(b.variety);
                        case 'health':
                            const healthOrder = ['Malo', 'Regular', 'Bueno', 'Excelente'];
                            return healthOrder.indexOf(a.health) - healthOrder.indexOf(b.health);
                        case 'productivity':
                            return b.productivity - a.productivity;
                        case 'location':
                            return a.location.sector.localeCompare(b.location.sector);
                        case 'nextHarvest':
                            return a.nextHarvest - b.nextHarvest;
                        default:
                            return 0;
                    }
                });

                return trees;
            }

            setFilter(filter) {
                this.currentFilter = filter;
                this.refreshView();
            }

            setSort(sort) {
                this.currentSort = sort;
                this.refreshView();
            }

            filterTrees(searchTerm) {
                this.refreshView();
            }

            // Métodos CRUD
            showAddTreeModal() {
                console.log('🌳 Mostrando modal para agregar árbol');
                
                const modal = document.getElementById('tree-modal');
                if (!modal) {
                    console.error('❌ Modal no encontrado');
                    return;
                }
                
                const form = document.getElementById('tree-form');
                const title = document.getElementById('modal-title');
                const submitText = document.getElementById('submit-text');
                
                if (title) title.textContent = 'Agregar Nuevo Árbol';
                if (submitText) submitText.textContent = 'Guardar Árbol';
                
                if (form) form.reset();
                const treeIdInput = document.getElementById('tree-id');
                if (treeIdInput) treeIdInput.value = '';
                
                // Generar próximo ID automáticamente
                this.generateNextTreeId().then(nextId => {
                    const treeCodeInput = document.getElementById('tree-code');
                    if (treeCodeInput) treeCodeInput.value = nextId;
                });
                
                modal.classList.remove('hidden');
                this.bindModalEvents();
                
                // Inicializar iconos de Lucide
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            async generateNextTreeId() {
                try {
                    const trees = await this.getTreesData();
                    if (trees.length === 0) return 'L001';
                    
                    const numbers = trees
                        .filter(t => t.id && t.id.startsWith('L'))
                        .map(t => {
                            const numStr = t.id.substring(1);
                            return parseInt(numStr) || 0;
                        })
                        .filter(n => !isNaN(n));
                        
                    const maxNumber = Math.max(0, ...numbers);
                    return `L${(maxNumber + 1).toString().padStart(3, '0')}`;
                } catch (error) {
                    console.error('Error generando ID:', error);
                    return 'L001';
                }
            }

            async showEditTreeModal(treeId) {
                const modal = document.getElementById('tree-modal');
                const form = document.getElementById('tree-form');
                const title = document.getElementById('modal-title');
                const submitText = document.getElementById('submit-text');
                
                const trees = await this.getTreesData();
                const tree = trees.find(t => t.id === treeId);
                
                if (!tree) {
                    console.error('Árbol no encontrado:', treeId);
                    return;
                }
                
                if (title) title.textContent = 'Editar Árbol';
                if (submitText) submitText.textContent = 'Actualizar Árbol';
                
                // Llenar formulario con datos existentes
                document.getElementById('tree-id').value = tree.id;
                document.getElementById('tree-code').value = tree.id;
                document.getElementById('tree-variety').value = tree.variety;
                document.getElementById('planted-date').value = tree.plantedDate;
                document.getElementById('tree-health').value = tree.health;
                document.getElementById('tree-sector').value = tree.location.sector;
                document.getElementById('tree-lat').value = tree.location.coordinates.lat;
                document.getElementById('tree-lng').value = tree.location.coordinates.lng;
                document.getElementById('tree-productivity').value = tree.productivity;
                document.getElementById('next-harvest').value = tree.nextHarvest;
                document.getElementById('tree-notes').value = tree.notes || '';
                
                modal.classList.remove('hidden');
                this.bindModalEvents();
                
                // Inicializar iconos de Lucide
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            bindModalEvents() {
                const modal = document.getElementById('tree-modal');
                const form = document.getElementById('tree-form');
                
                if (!modal || !form) return;
                
                // Cerrar modal
                modal.querySelectorAll('.modal-close').forEach(btn => {
                    btn.onclick = () => modal.classList.add('hidden');
                });
                
                // Cerrar al hacer clic fuera del modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                };
                
                // Manejar envío del formulario
                form.onsubmit = (e) => {
                    e.preventDefault();
                    this.saveTree();
                };
            }

            async saveTree() {
                const formData = {
                    id: document.getElementById('tree-code').value,
                    variety: document.getElementById('tree-variety').value,
                    plantedDate: document.getElementById('planted-date').value,
                    health: document.getElementById('tree-health').value,
                    location: {
                        sector: document.getElementById('tree-sector').value,
                        coordinates: {
                            lat: parseFloat(document.getElementById('tree-lat').value) || 0,
                            lng: parseFloat(document.getElementById('tree-lng').value) || 0
                        }
                    },
                    productivity: parseInt(document.getElementById('tree-productivity').value) || 75,
                    nextHarvest: parseInt(document.getElementById('next-harvest').value) || 30,
                    notes: document.getElementById('tree-notes').value
                };
                
                // Validar coordenadas
                if (formData.location.coordinates.lat === 0 || formData.location.coordinates.lng === 0) {
                    this.showNotification('Por favor, ingresa coordenadas válidas o usa el botón de GPS', 'warning');
                    return;
                }
                
                const existingId = document.getElementById('tree-id').value;
                
                try {
                    if (this.storage) {
                        if (existingId && existingId !== formData.id) {
                            // Actualizando árbol existente
                            await this.storage.updateTree(existingId, formData);
                            this.showNotification('Árbol actualizado correctamente', 'success');
                        } else if (!existingId) {
                            // Agregando nuevo árbol
                            await this.storage.addTree(formData);
                            this.showNotification('Nuevo árbol agregado correctamente', 'success');
                        }
                    } else {
                        console.log('Datos del árbol (simulación):', formData);
                        this.showNotification('Árbol guardado (modo simulación)', 'info');
                    }
                    
                    document.getElementById('tree-modal').classList.add('hidden');
                    this.refreshView();
                    
                } catch (error) {
                    console.error('Error guardando árbol:', error);
                    this.showNotification('Error al guardar el árbol', 'error');
                }
            }

            async deleteTree(treeId) {
                if (confirm('¿Estás seguro de que quieres eliminar este árbol? Esta acción no se puede deshacer.')) {
                    try {
                        if (this.storage) {
                            await this.storage.deleteTree(treeId);
                            this.showNotification('Árbol eliminado correctamente', 'success');
                        } else {
                            console.log('Eliminando árbol (simulación):', treeId);
                            this.showNotification('Árbol eliminado (modo simulación)', 'info');
                        }
                        this.refreshView();
                    } catch (error) {
                        console.error('Error eliminando árbol:', error);
                        this.showNotification('Error al eliminar el árbol', 'error');
                    }
                }
            }

            // Método para obtener ubicación GPS
            getGPSLocation() {
                if (!navigator.geolocation) {
                    this.showNotification('La geolocalización no es compatible con este navegador', 'error');
                    return;
                }

                this.showNotification('Obteniendo ubicación...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        document.getElementById('tree-lat').value = lat.toFixed(6);
                        document.getElementById('tree-lng').value = lng.toFixed(6);
                        
                        this.showNotification('Ubicación obtenida correctamente', 'success');
                    },
                    (error) => {
                        console.error('Error obteniendo ubicación:', error);
                        let errorMessage = 'Error desconocido al obtener la ubicación';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Permiso de ubicación denegado';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Información de ubicación no disponible';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Tiempo de espera agotado';
                                break;
                        }
                        
                        this.showNotification(errorMessage, 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }

            // Métodos auxiliares
            getHealthColor(health) {
                const colors = {
                    'Excelente': 'green',
                    'Bueno': 'blue',
                    'Regular': 'yellow',
                    'Malo': 'red'
                };
                return colors[health] || 'gray';
            }

            selectTree(treeId) {
                if (this.selectedTrees.has(treeId)) {
                    this.selectedTrees.delete(treeId);
                } else {
                    this.selectedTrees.add(treeId);
                }
            }

            showNotification(message, type = 'info') {
                // Usar la función showToast global si existe
                if (typeof showToast === 'function') {
                    showToast(message, type);
                } else {
                    // Implementación de fallback
                    console.log(`${type.toUpperCase()}: ${message}`);
                    alert(message);
                }
            }

            async refreshView() {
                const container = document.querySelector(this.container);
                if (container) {
                    container.innerHTML = await this.render();
                    // Volver a vincular eventos después de renderizar
                    this.bindEvents();
                    
                    // Inicializar iconos de Lucide
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            }
        }

        // === CLASE ANALYTICS PARA PRODUCTIVIDAD POR SECTOR ===
        class Analytics {
            constructor(options = {}) {
                this.container = options.container || '#content-area';
                this.storage = window.StorageManager || null;
                this.init();
            }

            init() {
                this.bindEvents();
            }

            bindEvents() {
                // Eventos para filtros y controles
                document.addEventListener('change', (e) => {
                    if (e.target.matches('#sector-select')) {
                        this.updateSectorData(e.target.value);
                    }
                    
                    if (e.target.matches('#time-range')) {
                        this.updateChartData();
                    }
                });
            }

            async render() {
                const productivity = await this.storage.getSectorProductivity();
                const sectors = Object.keys(productivity);
                
                return `
                    <div class="analytics-container p-6">
                        <!-- Header -->
                        <div class="analytics-header mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                                <i data-lucide="bar-chart-3" class="mr-3"></i>
                                Productividad por Sector
                            </h1>
                            <p class="text-gray-600">Análisis de rendimiento basado en datos de cosecha</p>
                        </div>

                        <!-- Controles -->
                        <div class="controls bg-white rounded-lg shadow-md p-6 mb-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Sector</label>
                                    <select id="sector-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="all">Todos los sectores</option>
                                        ${sectors.map(sector => `<option value="${sector}">Sector ${sector}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Rango de Tiempo</label>
                                    <select id="time-range" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="7">Última semana</option>
                                        <option value="30" selected>Último mes</option>
                                        <option value="90">Últimos 3 meses</option>
                                        <option value="365">Último año</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de Productividad -->
                        <div class="productivity-summary grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            ${this.renderProductivitySummary(productivity)}
                        </div>

                        <!-- Gráfico de Productividad -->
                        <div class="chart-container bg-white rounded-lg shadow-md p-6 mb-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Rendimiento por Sector</h3>
                            <div id="productivity-chart" class="h-64">
                                <div class="text-center py-16 text-gray-500">
                                    <i data-lucide="bar-chart-3" class="h-12 w-12 mx-auto mb-4 text-gray-400"></i>
                                    <p>No hay suficientes datos para mostrar el gráfico</p>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla Detallada -->
                        <div class="table-container bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Detalles por Sector</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sector</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Cosechado (kg)</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N° de Cosechas</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Promedio por Cosecha</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Actualización</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${this.renderProductivityTable(productivity)}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderProductivitySummary(productivity) {
                let totalHarvest = 0;
                let totalHarvests = 0;
                
                Object.values(productivity).forEach(sector => {
                    totalHarvest += sector.total;
                    totalHarvests += sector.harvests;
                });
                
                const avgPerHarvest = totalHarvests > 0 ? totalHarvest / totalHarvests : 0;
                
                return `
                    <div class="summary-card bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Total Cosechado</p>
                                <p class="text-2xl font-bold text-gray-800">${formatNumber(totalHarvest)} kg</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="scissors" class="h-6 w-6 text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Total de Cosechas</p>
                                <p class="text-2xl font-bold text-gray-800">${totalHarvests}</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="calendar" class="h-6 w-6 text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Promedio por Cosecha</p>
                                <p class="text-2xl font-bold text-gray-800">${formatNumber(avgPerHarvest)} kg</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="trending-up" class="h-6 w-6 text-yellow-600"></i>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderProductivityTable(productivity) {
                const sectors = Object.keys(productivity);
                
                if (sectors.length === 0) {
                    return `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                No hay datos de productividad disponibles
                            </td>
                        </tr>
                    `;
                }
                
                return sectors.map(sector => {
                    const data = productivity[sector];
                    const avgPerHarvest = data.harvests > 0 ? data.total / data.harvests : 0;
                    
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                Sector ${sector}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${formatNumber(data.total)} kg
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${data.harvests}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${formatNumber(avgPerHarvest)} kg
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${formatDate(data.lastUpdated)}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updateSectorData(sector) {
                // Implementar actualización de datos según el sector seleccionado
                console.log('Actualizando datos para sector:', sector);
            }

            updateChartData() {
                // Implementar actualización del gráfico según el rango de tiempo
                console.log('Actualizando gráfico con nuevo rango de tiempo');
            }

            async refreshView() {
                const container = document.querySelector(this.container);
                if (container) {
                    container.innerHTML = await this.render();
                    this.bindEvents();
                    
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            }
        }

        // === APLICACIÓN PRINCIPAL ===
        class FincaLimonApp {
            constructor() {
                this.currentRoute = 'dashboard';
                this.components = {};
                this.data = {
                    trees: [],
                    activities: [],
                    harvests: [],
                    user: null
                };
                
                this.storageManager = new StorageManager();
                this.init();
            }

            async init() {
                try {
                    console.log('🌱 Iniciando FincaLimón...');
                    
                    // Cargar datos iniciales
                    await this.loadInitialData();
                    
                    // Inicializar componentes
                    this.initializeComponents();
                    
                    // Configurar navegación
                    this.setupNavigation();
                    
                    // Configurar eventos globales
                    this.setupGlobalEvents();
                    
                    // Cargar ruta inicial
                    this.navigateToRoute(this.getCurrentRoute());
                    
                    // Ocultar loading screen y mostrar app
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('app').style.display = 'flex';
                    }, 2000); // Dar tiempo para que Firebase se conecte
                    
                    console.log('✅ FincaLimón App iniciada correctamente');
                    showToast('¡Aplicación cargada correctamente!', 'success');
                    
                } catch (error) {
                    console.error('❌ Error iniciando la aplicación:', error);
                    this.showError('Error al inicializar la aplicación');
                }
            }

            async loadInitialData() {
                // Intentar cargar datos del storage (Firebase + localStorage)
                try {
                    const savedTrees = await this.storageManager.getTrees();
                    
                    if (savedTrees && savedTrees.length > 0) {
                        this.data.trees = savedTrees;
                        console.log('📊 Datos cargados desde storage');
                    } else {
                        // Si no hay datos guardados, cargar datos mock
                        this.data = await loadMockData();
                        // Guardar datos mock
                        await this.storageManager.saveTrees(this.data.trees);
                        console.log('📊 Datos iniciales cargados (mock data)');
                    }
                } catch (error) {
                    console.error('Error cargando datos iniciales:', error);
                    this.data = await loadMockData();
                }
            }

            initializeComponents() {
                // Inicializar sidebar
                this.components.sidebar = new Sidebar({
                    container: '#sidebar',
                    onNavigate: (route) => this.navigateToRoute(route)
                });

                // Inicializar componente dashboard
                this.components.dashboard = new Dashboard({
                    container: '#content-area',
                    data: this.data
                });

                // Inicializar componente trees con StorageManager
                this.components.trees = new Trees({
                    container: '#content-area',
                    data: this.data,
                    onDataUpdate: (newData) => this.updateData(newData)
                });

                // Inicializar componente analytics
                this.components.analytics = new Analytics({
                    container: '#content-area',
                    storage: this.storageManager
                });
                
                console.log('🔧 Componentes inicializados');
            }

            setupNavigation() {
                // Navegación por hash
                window.addEventListener('hashchange', () => {
                    const route = this.getCurrentRoute();
                    this.navigateToRoute(route);
                });

                console.log('🧭 Navegación configurada');
            }

            setupGlobalEvents() {
                // Manejo de errores globales
                window.addEventListener('error', (e) => {
                    console.error('Error global:', e.error);
                    this.showError('Ha ocurrido un error inesperado');
                });

                // Guardar datos antes de cerrar
                window.addEventListener('beforeunload', async () => {
                    if (this.storageManager && this.data.trees) {
                        await this.storageManager.saveTrees(this.data.trees);
                    }
                });

                // Responsive sidebar toggle
                const sidebarToggle = document.getElementById('sidebar-toggle');
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', () => {
                        this.toggleSidebar();
                    });
                }

                console.log('🎛️ Eventos globales configurados');
            }

            getCurrentRoute() {
                const hash = window.location.hash.slice(1);
                return hash || 'dashboard';
            }

            navigateToRoute(route) {
                // Validar que la ruta existe
                if (!ROUTES[route]) {
                    console.warn(`Ruta no encontrada: ${route}`);
                    route = 'dashboard';
                }

                // Actualizar hash si es necesario
                if (window.location.hash.slice(1) !== route) {
                    window.location.hash = route;
                }

                // Actualizar estado actual
                this.currentRoute = route;

                // Actualizar sidebar
                this.components.sidebar.setActiveRoute(route);

                // Actualizar título de página
                this.updatePageTitle(route);

                // Renderizar componente correspondiente
                this.renderCurrentComponent();

                console.log(`📍 Navegando a: ${route}`);
            }

            updatePageTitle(route) {
                const titles = {
                    harvest: { title: 'Gestión de Cosechas', subtitle: 'Controla la producción de limones' },
                    dashboard: { title: 'Panel Principal', subtitle: 'Resumen general de tu finca de limones' },
                    trees: { title: 'Gestión de Árboles', subtitle: 'Administra tus árboles de limón' },
                    harvest: { title: 'Registro de Cosechas', subtitle: 'Controla la producción de limones' },
                    fertilizer: { title: 'Control de Abonos', subtitle: 'Gestiona la fertilización' },
                    spray: { title: 'Control de Fumigaciones', subtitle: 'Manejo de plagas y enfermedades' },
                    analytics: { title: 'Análisis de Productividad', subtitle: 'Estadísticas y reportes' },
                    map: { title: 'Mapa GPS', subtitle: 'Ubicación de árboles y sectores' },
                    calendar: { title: 'Calendario de Actividades', subtitle: 'Planifica tus tareas agrícolas' }
                };

                const pageInfo = titles[route] || titles.dashboard;
                document.getElementById('page-title').textContent = pageInfo.title;
                document.getElementById('page-subtitle').textContent = pageInfo.subtitle;
                document.title = `${pageInfo.title} - FincaLimón`;
            }

            async renderCurrentComponent() {
                const component = this.components[this.currentRoute];
                if (component && typeof component.render === 'function') {
                    const container = document.getElementById('content-area');
                    if (container) {
                        container.innerHTML = await component.render();
                        
                        // Reinicializar eventos si es Trees
                        if (this.currentRoute === 'trees' && component.bindEvents) {
                            component.bindEvents();
                        }
                        
                        // Inicializar iconos de Lucide
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    }
                } else {
                    // Para rutas que aún no tienen componente, mostrar mensaje
                    this.renderPlaceholder();
                }
            }

            renderPlaceholder() {
                const container = document.getElementById('content-area');
                const routeInfo = ROUTES[this.currentRoute];
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center">
                        <div class="text-6xl mb-4">🚧</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">${routeInfo ? routeInfo.title : 'Sección'}</h2>
                        <p class="text-gray-600 mb-4">Esta sección está en desarrollo.</p>
                        <button onclick="window.app.navigateToRoute('dashboard')" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            Ir al Dashboard
                        </button>
                    </div>
                `;
            }

            async updateData(newData) {
                // Actualizar datos en memoria
                this.data = { ...this.data, ...newData };
                
                // Guardar en storage (Firebase + localStorage)
                if (this.storageManager && newData.trees) {
                    await this.storageManager.saveTrees(newData.trees);
                }
                
                // Notificar a componentes que dependen de los datos
                this.notifyDataUpdate();
                
                console.log('📊 Datos actualizados:', Object.keys(newData));
            }

            notifyDataUpdate() {
                // Actualizar componentes que muestran estadísticas
                if (this.components.dashboard) {
                    this.components.dashboard.updateData(this.data);
                }
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('sidebar-open');
            }

            showError(message) {
                showToast(message, 'error', 5000);
            }

            showSuccess(message) {
                showToast(message, 'success', 3000);
            }

            // Métodos públicos para interactuar con la app
            getData() {
                return { ...this.data };
            }

            getCurrentComponent() {
                return this.components[this.currentRoute];
            }

            refresh() {
                this.renderCurrentComponent();
            }
        }

        // Crear instancia global del StorageManager
        const storageManager = new StorageManager();
        window.StorageManager = storageManager;

        // Hacer la clase Trees disponible globalmente
        window.Trees = Trees;

        // Hacer la clase Analytics disponible globalmente
        window.Analytics = Analytics;

        // Inicializar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            // Crear instancia global de la aplicación
            window.app = new FincaLimonApp();

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>

    <!-- CSS adicional para sidebar responsive -->
    <style>
        .sidebar {
            width: 280px;
            z-index: 30;
        }

        .sidebar-open {
            transform: translateX(0);
        }

        .nav-item.active {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .nav-item:hover:not(.active) {
            background-color: #f3f4f6;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.sidebar-open {
                transform: translateX(0);
            }

            .sidebar-text {
                display: block;
            }
        }

        @media (min-width: 769px) {
            .sidebar {
                position: relative;
                transform: translateX(0);
            }
        }

        /* Estilos adicionales para Trees */
        .add-tree-btn {
            background: var(--primary-green, #059669);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .add-tree-btn:hover {
            background: var(--primary-green-dark, #047857);
            transform: translateY(-1px);
        }

        .tree-modal.hidden {
            display: none;
        }

        .form-section h3 {
            color: var(--gray-800, #1f2937);
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-100, #f3f4f6);
        }

        /* Loading animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Animación para el indicador de Firebase */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</body>
</html>
