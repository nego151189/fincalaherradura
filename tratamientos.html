<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Tratamientos ¬∑ Finca La Herradura</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#7CB342" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
</head>
<body>
  <!-- Indicador de conectividad mejorado -->
  <div id="connectivityIndicator" class="connectivity-indicator offline" aria-live="polite" role="status">
    <span class="connectivity-dot" aria-hidden="true"></span>
    <span id="connectivityText">Sin Internet</span>
    <span id="pendingBadge" class="pending-badge hidden" aria-label="Tratamientos pendientes">0</span>
  </div>

  <main class="page treatments-page">
    <!-- Header con gradiente mejorado -->
    <header class="page-header">
      <div class="header-content">
        <div class="header-text">
          <h1>üß™ Tratamientos Fitosanitarios</h1>
          <p class="subtitle">Control integral de plagas y enfermedades</p>
        </div>
        <div class="header-actions">
          <button id="syncBtn" class="btn-icon-header" aria-label="Sincronizar datos">
            <span class="icon">üîÑ</span>
          </button>
        </div>
      </div>
    </header>

    <!-- KPIs del d√≠a con animaciones -->
    <section class="stats-section" role="region" aria-labelledby="stats-title">
      <h2 id="stats-title" class="section-title visually-hidden">Estad√≠sticas del d√≠a</h2>
      <div class="stat-card animate-on-load" style="--delay: 0.1s">
        <div class="stat-icon">üíâ</div>
        <div class="stat-content">
          <div class="stat-number" id="kpiTreatments">0</div>
          <div class="stat-label">Tratamientos hoy</div>
        </div>
      </div>
      <div class="stat-card animate-on-load" style="--delay: 0.2s">
        <div class="stat-icon">üå≥</div>
        <div class="stat-content">
          <div class="stat-number" id="kpiTreesTreated">0</div>
          <div class="stat-label">√Årboles tratados</div>
        </div>
      </div>
      <div class="stat-card animate-on-load" style="--delay: 0.3s">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <div class="stat-number" id="kpiCostTotal">Q0</div>
          <div class="stat-label">Costo total</div>
        </div>
      </div>
      <div class="stat-card animate-on-load" style="--delay: 0.4s">
        <div class="stat-icon">üéØ</div>
        <div class="stat-content">
          <div class="stat-number" id="kpiTopProblem">‚Äî</div>
          <div class="stat-label">Problema principal</div>
        </div>
      </div>
    </section>

    <!-- Selecci√≥n de √°rboles mejorada -->
    <section class="form-section animate-on-load" style="--delay: 0.5s" role="region" aria-labelledby="tree-selection-title">
      <div class="card modern-card">
        <div class="card-header">
          <h2 id="tree-selection-title">üå≥ Selecci√≥n de √Årboles</h2>
          <div class="tree-counter">
            <span id="selectedCount" class="pill pill-ok">0 seleccionados</span>
          </div>
        </div>
        <div class="card-body">
          <!-- Controles de b√∫squeda y selecci√≥n -->
          <div class="tree-controls">
            <div class="form-group-row">
              <div class="form-group">
                <label class="label" for="treeSearch">
                  <span class="label-icon">üîç</span>
                  Buscar √°rboles
                </label>
                <div class="input-wrapper">
                  <input id="treeSearch" 
                         class="input modern-input" 
                         type="search" 
                         placeholder="Ej. ARB120, 120, o 100-150"
                         autocomplete="off"
                         aria-describedby="search-help" />
                  <div class="input-icon">üå≤</div>
                </div>
                <div id="search-help" class="input-help">
                  Formatos: ARB001, 120, ARB100-ARB150, 50-75
                </div>
              </div>
              
              <div class="form-group">
                <label class="label" for="quickSelect">
                  <span class="label-icon">‚ö°</span>
                  Selecci√≥n r√°pida
                </label>
                <div class="input-wrapper">
                  <input id="quickSelect" 
                         class="input modern-input" 
                         type="text" 
                         placeholder="Ej. ARB001, ARB010-ARB020, 35-40"
                         autocomplete="off"
                         aria-describedby="quick-help" />
                  <div class="input-icon">üìù</div>
                </div>
                <div id="quick-help" class="input-help">
                  Separar m√∫ltiples selecciones con comas
                </div>
              </div>
            </div>

            <!-- Botones de acci√≥n r√°pida -->
            <div class="quick-actions-row">
              <button id="applyQuickBtn" class="btn btn-primary">
                <span class="btn-icon">‚úÖ</span>
                Aplicar
              </button>
              <button id="selectAllBtn" class="btn btn-secondary">
                <span class="btn-icon">üëÜ</span>
                Todos
              </button>
              <button id="clearSelBtn" class="btn btn-outline">
                <span class="btn-icon">üßπ</span>
                Limpiar
              </button>
              <button id="filterByStateBtn" class="btn btn-outline dropdown-toggle" aria-expanded="false">
                <span class="btn-icon">üéõÔ∏è</span>
                Filtros
                <span class="dropdown-arrow">‚ñº</span>
              </button>
            </div>

            <!-- Dropdown de filtros -->
            <div id="filterDropdown" class="dropdown-menu hidden">
              <div class="dropdown-header">Filtrar por estado:</div>
              <button class="dropdown-item" data-filter="sano">
                <span class="status-dot sano"></span>
                Solo √°rboles sanos
              </button>
              <button class="dropdown-item" data-filter="hlb">
                <span class="status-dot hlb"></span>
                Con HLB
              </button>
              <button class="dropdown-item" data-filter="pulgon">
                <span class="status-dot pulgon"></span>
                Con pulg√≥n
              </button>
              <button class="dropdown-item" data-filter="fumagina">
                <span class="status-dot fumagina"></span>
                Con fumagina
              </button>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" data-filter="all">
                <span class="status-dot all"></span>
                Mostrar todos
              </button>
            </div>
          </div>

          <!-- Grid de √°rboles mejorado -->
          <div class="tree-selection-area">
            <div class="tree-grid-header">
              <span class="grid-title">√Årboles disponibles (ARB001 - ARB800)</span>
              <div class="grid-legend">
                <div class="legend-item">
                  <span class="legend-dot sano"></span>
                  <span class="legend-text">Sano</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot hlb"></span>
                  <span class="legend-text">HLB</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot pulgon"></span>
                  <span class="legend-text">Pulg√≥n</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot fumagina"></span>
                  <span class="legend-text">Fumagina</span>
                </div>
              </div>
            </div>
            
            <div id="treeGrid" 
                 class="tree-grid compact" 
                 role="grid" 
                 aria-label="Selecci√≥n de √°rboles"
                 aria-multiselectable="true">
              <!-- Los √°rboles se cargar√°n din√°micamente aqu√≠ -->
            </div>
            
            <div id="treeGridLoading" class="tree-grid-loading hidden">
              <div class="loading-spinner"></div>
              <p>Cargando √°rboles...</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Detalle del tratamiento mejorado -->
    <section class="form-section animate-on-load" style="--delay: 0.6s" role="region" aria-labelledby="treatment-form-title">
      <div class="card modern-card">
        <div class="card-header">
          <h2 id="treatment-form-title">üß¥ Detalle del Tratamiento</h2>
          <div class="form-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 0%"></div>
            </div>
            <span class="progress-text">0% completado</span>
          </div>
        </div>
        <div class="card-body">
          <form id="treatmentForm" novalidate>
            <!-- Problema y efectividad -->
            <div class="form-group-row">
              <div class="form-group">
                <label class="label required" for="problem">
                  <span class="label-icon">üêõ</span>
                  Problema a tratar
                </label>
                <div class="select-wrapper">
                  <select id="problem" class="select modern-select" required aria-describedby="problem-error">
                    <option value="">Seleccionar problema...</option>
                    <option value="hlb">üü° HLB (Huanglongbing)</option>
                    <option value="pulgon">üü† Pulg√≥n</option>
                    <option value="fumagina">üî¥ Fumagina</option>
                    <option value="otro">üîß Otro</option>
                  </select>
                  <div class="select-icon">‚¨áÔ∏è</div>
                </div>
                <div id="problem-error" class="error-message hidden" role="alert"></div>
                <div class="problem-description" id="problemDescription"></div>
              </div>
              
              <div class="form-group">
                <label class="label" for="effect">
                  <span class="label-icon">üìä</span>
                  Efectividad esperada
                </label>
                <div class="select-wrapper">
                  <select id="effect" class="select modern-select" aria-describedby="effect-help">
                    <option value="pendiente">‚è≥ Pendiente</option>
                    <option value="baja">üî¥ Baja (20-40%)</option>
                    <option value="media">üü° Media (40-70%)</option>
                    <option value="alta">üü¢ Alta (70-95%)</option>
                  </select>
                  <div class="select-icon">‚¨áÔ∏è</div>
                </div>
                <div id="effect-help" class="input-help">
                  Se puede actualizar despu√©s del tratamiento
                </div>
              </div>
            </div>

            <!-- Producto y dosis -->
            <div class="form-group-row">
              <div class="form-group">
                <label class="label required" for="product">
                  <span class="label-icon">üß™</span>
                  Producto utilizado
                </label>
                <div class="input-wrapper">
                  <input id="product" 
                         class="input modern-input" 
                         type="text" 
                         placeholder="Ej. Imidacloprid 200 SL"
                         required
                         list="productSuggestions"
                         autocomplete="off"
                         aria-describedby="product-error" />
                  <div class="input-icon">üíä</div>
                </div>
                <datalist id="productSuggestions">
                  <option value="Imidacloprid 200 SL">
                  <option value="Aceite mineral">
                  <option value="Jab√≥n pot√°sico">
                  <option value="Sulfato de cobre">
                  <option value="Bicarbonato de sodio">
                </datalist>
                <div id="product-error" class="error-message hidden" role="alert"></div>
              </div>
              
              <div class="form-group">
                <label class="label required" for="dose">
                  <span class="label-icon">‚öóÔ∏è</span>
                  Dosis aplicada
                </label>
                <div class="input-wrapper">
                  <input id="dose" 
                         class="input modern-input" 
                         type="text" 
                         placeholder="Ej. 10 ml/L, 2%"
                         required
                         autocomplete="off"
                         aria-describedby="dose-error dose-help" />
                  <div class="input-icon">üìè</div>
                </div>
                <div id="dose-help" class="input-help">
                  Incluir unidades: ml/L, g/L, %
                </div>
                <div id="dose-error" class="error-message hidden" role="alert"></div>
              </div>
            </div>

            <!-- Costo y fecha/hora -->
            <div class="form-group-row">
              <div class="form-group">
                <label class="label" for="cost">
                  <span class="label-icon">üí∞</span>
                  Costo del tratamiento
                </label>
                <div class="number-input-wrapper">
                  <div class="currency-symbol">Q</div>
                  <input id="cost" 
                         class="number-input modern-input" 
                         type="number" 
                         inputmode="decimal" 
                         step="0.01" 
                         min="0" 
                         value="0.00"
                         aria-describedby="cost-help" />
                  <div class="input-controls">
                    <button type="button" class="btn-stepper" data-action="increment" data-target="cost" aria-label="Incrementar costo">+</button>
                    <button type="button" class="btn-stepper" data-action="decrement" data-target="cost" aria-label="Decrementar costo">-</button>
                  </div>
                </div>
                <div class="quick-amounts">
                  <button type="button" class="btn-quick" data-add="#cost" data-val="25">+Q25</button>
                  <button type="button" class="btn-quick" data-add="#cost" data-val="50">+Q50</button>
                  <button type="button" class="btn-quick" data-add="#cost" data-val="100">+Q100</button>
                  <button type="button" class="btn-quick" data-add="#cost" data-val="-10">-Q10</button>
                </div>
                <div id="cost-help" class="input-help">
                  Incluye producto, mano de obra y equipos
                </div>
              </div>
              
              <div class="form-group">
                <label class="label" for="dateInput">
                  <span class="label-icon">üìÖ</span>
                  Fecha y hora
                </label>
                <div class="datetime-wrapper">
                  <div class="datetime-inputs">
                    <input id="dateInput" 
                           class="input modern-input datetime-input" 
                           type="date" 
                           aria-label="Fecha del tratamiento" />
                    <input id="timeInput" 
                           class="input modern-input datetime-input" 
                           type="time" 
                           aria-label="Hora del tratamiento" />
                  </div>
                  <button type="button" id="setNowBtn" class="btn-quick">
                    <span class="btn-icon">üïê</span>
                    Ahora
                  </button>
                </div>
              </div>
            </div>

            <!-- Observaciones -->
            <div class="form-group">
              <label class="label" for="notes">
                <span class="label-icon">üìù</span>
                Observaciones del tratamiento
                <span class="label-optional">(opcional)</span>
              </label>
              <div class="textarea-wrapper">
                <textarea id="notes" 
                          class="textarea modern-input" 
                          rows="3" 
                          placeholder="Ej. Aplicaci√≥n temprano, sin viento, condiciones ideales..."
                          maxlength="300"
                          aria-describedby="notes-counter"></textarea>
                <div id="notes-counter" class="character-counter">0/300</div>
              </div>
            </div>

            <!-- Resumen del tratamiento -->
            <div id="treatmentSummary" class="treatment-summary hidden">
              <h3 class="summary-title">üìã Resumen del Tratamiento</h3>
              <div class="summary-grid">
                <div class="summary-item">
                  <span class="summary-label">√Årboles:</span>
                  <span id="summaryTrees" class="summary-value">0 seleccionados</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Problema:</span>
                  <span id="summaryProblem" class="summary-value">-</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Producto:</span>
                  <span id="summaryProduct" class="summary-value">-</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Costo total:</span>
                  <span id="summaryCost" class="summary-value">Q0.00</span>
                </div>
              </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="form-actions">
              <button type="submit" id="saveTreatmentBtn" class="btn btn-primary btn-large">
                <span class="btn-icon">üíæ</span>
                <span class="btn-text">Guardar Tratamiento</span>
                <div class="btn-loading hidden">
                  <div class="spinner"></div>
                </div>
              </button>
              
              <div class="secondary-actions">
                <button type="button" id="clearFormBtn" class="btn btn-outline">
                  <span class="btn-icon">üßπ</span>
                  Limpiar Formulario
                </button>
                <button type="button" id="saveDraftBtn" class="btn btn-secondary">
                  <span class="btn-icon">üìÑ</span>
                  Guardar Borrador
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Lista de tratamientos de hoy mejorada -->
    <section class="list-section animate-on-load" style="--delay: 0.7s" role="region" aria-labelledby="treatments-list-title">
      <div class="card modern-card">
        <div class="card-header">
          <h2 id="treatments-list-title">üìú Tratamientos de Hoy</h2>
          <div class="list-controls">
            <button id="filterListBtn" class="btn-icon-small" aria-label="Filtrar lista">
              <span class="icon">üîç</span>
            </button>
            <button id="exportListBtn" class="btn-icon-small" aria-label="Exportar lista">
              <span class="icon">üì§</span>
            </button>
          </div>
        </div>
        <div class="card-body">
          <!-- Resumen del d√≠a -->
          <div class="treatments-summary">
            <div class="summary-item">
              <span class="summary-label">Total de tratamientos:</span>
              <span id="dailyTreatments" class="summary-value">0</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Costo total del d√≠a:</span>
              <span id="dailyCost" class="summary-value">Q0.00</span>
            </div>
          </div>
          
          <!-- Tabla responsive -->
          <div class="table-responsive">
            <div class="table-header">
              <div class="table-cell">Hora</div>
              <div class="table-cell">Problema</div>
              <div class="table-cell">Producto</div>
              <div class="table-cell">√Årboles</div>
              <div class="table-cell">Costo</div>
              <div class="table-cell">Efectividad</div>
              <div class="table-cell">Acciones</div>
            </div>
            <div id="treatList" class="table-body">
              <!-- Los tratamientos se cargar√°n aqu√≠ din√°micamente -->
              <div class="empty-state">
                <div class="empty-icon">üß™</div>
                <p class="empty-message">No hay tratamientos registrados hoy</p>
                <p class="empty-submessage">Los tratamientos que registres aparecer√°n aqu√≠</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast notifications -->
  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <!-- Modal de confirmaci√≥n -->
  <div id="confirmModal" class="modal hidden" role="dialog" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Confirmar acci√≥n</h3>
        <button class="modal-close" aria-label="Cerrar modal">&times;</button>
      </div>
      <div class="modal-body">
        <p id="modalMessage">¬øEst√°s seguro de realizar esta acci√≥n?</p>
      </div>
      <div class="modal-actions">
        <button id="modalCancel" class="btn btn-outline">Cancelar</button>
        <button id="modalConfirm" class="btn btn-primary">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script src="js/firebase-config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/offline.js"></script>
  <script src="js/nav.js"></script>
  <script src="js/tratamientos.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistration().then(reg => {
        if (!reg) navigator.serviceWorker.register('/sw.js').catch(console.error);
      });
    }

    // Inicializaci√≥n de componentes
    document.addEventListener('DOMContentLoaded', function() {
      // Animaciones de carga
      const animatedElements = document.querySelectorAll('.animate-on-load');
      animatedElements.forEach((el, index) => {
        setTimeout(() => {
          el.classList.add('animate-in');
        }, index * 100);
      });

      // Configurar fecha y hora actual por defecto
      const now = new Date();
      const dateInput = document.getElementById('dateInput');
      const timeInput = document.getElementById('timeInput');
      
      dateInput.value = now.toISOString().split('T')[0];
      timeInput.value = now.toTimeString().slice(0, 5);

      // Bot√≥n "Ahora"
      document.getElementById('setNowBtn').addEventListener('click', function() {
        const now = new Date();
        dateInput.value = now.toISOString().split('T')[0];
        timeInput.value = now.toTimeString().slice(0, 5);
      });
    });
  </script>
</body>
</html>
