<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Producci√≥n ¬∑ Finca La Herradura</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#7CB342" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
</head>
<body>
  <!-- Indicador de conectividad -->
  <div id="connectivityIndicator" class="connectivity-indicator offline" aria-live="polite">
    <span class="connectivity-dot"></span>
    <span id="connectivityText">Sin Internet</span>
    <span id="pendingBadge" class="pending-badge hidden">0</span>
  </div>

  <main class="page production-page">
    <header class="page-header">
      <div class="header-content">
        <div class="header-text">
          <h1>üåø Registrar cosecha</h1>
          <p class="subtitle">Control de producci√≥n individual y por bloques</p>
        </div>
        <div class="header-actions">
          <button id="syncBtn" class="btn-icon-header" aria-label="Sincronizar datos">
            <span class="icon">üîÑ</span>
          </button>
        </div>
      </div>
    </header>

    <!-- KPIs del d√≠a -->
    <section class="stats-section">
      <div class="stat-card animate-on-load" style="--delay: 0.1s">
        <div class="stat-icon">üì¶</div>
        <div class="stat-content">
          <div class="stat-number" id="kpiProdUnits">0</div>
          <div class="stat-label">Unidades hoy</div>
        </div>
      </div>
      <div class="stat-card animate-on-load" style="--delay: 0.2s">
        <div class="stat-icon">üå≥</div>
        <div class="stat-content">
          <div class="stat-number" id="kpiProdTrees">0</div>
          <div class="stat-label">√Årboles cosechados</div>
        </div>
      </div>
      <div class="stat-card animate-on-load" style="--delay: 0.3s">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <div class="stat-number" id="kpiProdBlocks">0</div>
          <div class="stat-label">Bloques cosechados</div>
        </div>
      </div>
      <div class="stat-card animate-on-load" style="--delay: 0.4s">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <div class="stat-number" id="kpiProdValue">Q0</div>
          <div class="stat-label">Valor estimado</div>
        </div>
      </div>
      <div class="stat-card animate-on-load" style="--delay: 0.5s">
        <div class="stat-icon">üíµ</div>
        <div class="stat-content">
          <div class="stat-number" id="kpiUnitPrice">Q0.00</div>
          <div class="stat-label">Precio por unidad</div>
        </div>
      </div>
    </section>

    <!-- Selector de modo de registro -->
    <section class="mode-section animate-on-load" style="--delay: 0.6s">
      <div class="card modern-card">
        <div class="card-header">
          <h2>üìù Modo de registro</h2>
        </div>
        <div class="card-body">
          <div class="mode-selector">
            <input type="radio" id="modeTree" name="registrationMode" value="tree" class="mode-radio" checked>
            <label for="modeTree" class="mode-label">
              <span class="mode-icon">üå≥</span>
              <span class="mode-text">Por √°rbol individual</span>
              <span class="mode-desc">Registro preciso √°rbol por √°rbol</span>
            </label>
            
            <input type="radio" id="modeBlock" name="registrationMode" value="block" class="mode-radio">
            <label for="modeBlock" class="mode-label">
              <span class="mode-icon">üìã</span>
              <span class="mode-text">Por bloque de 100</span>
              <span class="mode-desc">Registro r√°pido por sectores</span>
            </label>
          </div>
        </div>
      </div>
    </section>

    <!-- Formulario por √°rbol individual -->
    <section id="treeRegistration" class="form-section animate-on-load" style="--delay: 0.7s">
      <div class="card modern-card">
        <div class="card-header">
          <h2>üå≥ Seleccionar √°rbol</h2>
          <div class="tree-info">
            <span id="treeCount">800 √°rboles total</span>
          </div>
        </div>
        <div class="card-body">
          <div class="form-group-row">
            <div class="form-group">
              <label class="label" for="treeSearch">Buscar ARB001‚Ä¶ARB800</label>
              <div class="search-wrapper">
                <input id="treeSearch" class="input modern-input" type="search" placeholder="Ej. ARB123" />
                <div class="search-icon">üîç</div>
              </div>
            </div>
            <div class="form-group">
              <label class="label">√Årbol seleccionado</label>
              <div id="selectedTree" class="selected-tree">‚Äî</div>
            </div>
          </div>
          <div id="treeGrid" class="tree-grid compact" role="list" aria-label="Selector de √°rboles"></div>
        </div>
      </div>
    </section>

    <!-- Formulario por bloque -->
    <section id="blockRegistration" class="form-section animate-on-load hidden" style="--delay: 0.7s">
      <div class="card modern-card">
        <div class="card-header">
          <h2>üìã Seleccionar bloque</h2>
          <div class="block-info">
            <span id="blockCount">8 bloques de 100 √°rboles</span>
          </div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label class="label required" for="blockSelect">Bloque a cosechar</label>
            <div class="select-wrapper">
              <select id="blockSelect" class="select modern-select" required>
                <option value="">Seleccionar bloque...</option>
                <option value="B1">Bloque 1 (ARB001-ARB100)</option>
                <option value="B2">Bloque 2 (ARB101-ARB200)</option>
                <option value="B3">Bloque 3 (ARB201-ARB300)</option>
                <option value="B4">Bloque 4 (ARB301-ARB400)</option>
                <option value="B5">Bloque 5 (ARB401-ARB500)</option>
                <option value="B6">Bloque 6 (ARB501-ARB600)</option>
                <option value="B7">Bloque 7 (ARB601-ARB700)</option>
                <option value="B8">Bloque 8 (ARB701-ARB800)</option>
              </select>
              <div class="select-icon">‚¨áÔ∏è</div>
            </div>
            <div class="input-help">
              <span id="blockRange">Selecciona un bloque para ver el rango de √°rboles</span>
            </div>
          </div>
          
          <div id="blockStats" class="block-stats hidden">
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">√Årboles en bloque:</span>
                <span class="stat-value">100</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">√öltima cosecha:</span>
                <span id="lastHarvest" class="stat-value">‚Äî</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Promedio hist√≥rico:</span>
                <span id="avgProduction" class="stat-value">‚Äî</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Formulario de unidades (compartido) -->
    <section class="form-section animate-on-load" style="--delay: 0.8s">
      <div class="card modern-card">
        <div class="card-header">
          <h2 id="unitsTitle">üßÆ Unidades por √°rbol</h2>
        </div>
        <div class="card-body">
          <div class="form-group-row three-cols">
            <div class="form-group">
              <label class="label required" for="uPrimera">
                <span class="label-icon">ü•á</span>
                Primera calidad
              </label>
              <div class="number-input-wrapper">
                <input id="uPrimera" class="number-input modern-input" type="number" inputmode="numeric" min="0" value="0" />
                <div class="input-controls">
                  <button type="button" class="btn-stepper" data-action="increment" data-target="uPrimera">+</button>
                  <button type="button" class="btn-stepper" data-action="decrement" data-target="uPrimera">-</button>
                </div>
              </div>
              <div class="quick-amounts">
                <button type="button" class="btn-quick" data-add="#uPrimera" data-val="10">+10</button>
                <button type="button" class="btn-quick" data-add="#uPrimera" data-val="50">+50</button>
                <button type="button" class="btn-quick" data-add="#uPrimera" data-val="-10">-10</button>
              </div>
            </div>
            
            <div class="form-group">
              <label class="label required" for="uSegunda">
                <span class="label-icon">ü•à</span>
                Segunda calidad
              </label>
              <div class="number-input-wrapper">
                <input id="uSegunda" class="number-input modern-input" type="number" inputmode="numeric" min="0" value="0" />
                <div class="input-controls">
                  <button type="button" class="btn-stepper" data-action="increment" data-target="uSegunda">+</button>
                  <button type="button" class="btn-stepper" data-action="decrement" data-target="uSegunda">-</button>
                </div>
              </div>
              <div class="quick-amounts">
                <button type="button" class="btn-quick" data-add="#uSegunda" data-val="10">+10</button>
                <button type="button" class="btn-quick" data-add="#uSegunda" data-val="50">+50</button>
                <button type="button" class="btn-quick" data-add="#uSegunda" data-val="-10">-10</button>
              </div>
            </div>
            
            <div class="form-group">
              <label class="label required" for="uDescarte">
                <span class="label-icon">üóëÔ∏è</span>
                Descarte
              </label>
              <div class="number-input-wrapper">
                <input id="uDescarte" class="number-input modern-input" type="number" inputmode="numeric" min="0" value="0" />
                <div class="input-controls">
                  <button type="button" class="btn-stepper" data-action="increment" data-target="uDescarte">+</button>
                  <button type="button" class="btn-stepper" data-action="decrement" data-target="uDescarte">-</button>
                </div>
              </div>
              <div class="quick-amounts">
                <button type="button" class="btn-quick" data-add="#uDescarte" data-val="10">+10</button>
                <button type="button" class="btn-quick" data-add="#uDescarte" data-val="50">+50</button>
                <button type="button" class="btn-quick" data-val="-10">-10</button>
              </div>
            </div>
          </div>

          <!-- Totales del bloque (solo visible en modo bloque) -->
          <div id="blockTotals" class="block-totals hidden">
            <div class="totals-header">
              <h3>üìä Totales del bloque</h3>
            </div>
            <div class="totals-grid">
              <div class="total-item">
                <span class="total-label">Total primera:</span>
                <span id="totalPrimera" class="total-value">0 unidades</span>
              </div>
              <div class="total-item">
                <span class="total-label">Total segunda:</span>
                <span id="totalSegunda" class="total-value">0 unidades</span>
              </div>
              <div class="total-item">
                <span class="total-label">Total descarte:</span>
                <span id="totalDescarte" class="total-value">0 unidades</span>
              </div>
              <div class="total-item highlight">
                <span class="total-label">Gran total:</span>
                <span id="grandTotal" class="total-value">0 unidades</span>
              </div>
              <div class="total-item">
                <span class="total-label">Promedio por √°rbol:</span>
                <span id="avgPerTree" class="total-value">0.0 unidades</span>
              </div>
            </div>
          </div>

          <div class="form-group-row">
            <div class="form-group">
              <label class="label required" for="workerSelect">
                <span class="label-icon">üë•</span>
                Trabajador responsable
              </label>
              <div class="select-wrapper">
                <select id="workerSelect" class="select modern-select">
                  <option value="trabajador1">Trabajador 1</option>
                  <option value="trabajador2">Trabajador 2</option>
                  <option value="trabajador3">Trabajador 3</option>
                  <option value="cuadrilla1">Cuadrilla 1</option>
                  <option value="cuadrilla2">Cuadrilla 2</option>
                </select>
                <div class="select-icon">‚¨áÔ∏è</div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="label" for="harvestTime">
                <span class="label-icon">üïê</span>
                Hora de cosecha
              </label>
              <div class="time-wrapper">
                <input id="harvestTime" class="input modern-input" type="time" />
                <button type="button" id="setNowBtn" class="btn-quick">Ahora</button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="label" for="notes">
              <span class="label-icon">üìù</span>
              Observaciones
              <span class="label-optional">(opcional)</span>
            </label>
            <div class="textarea-wrapper">
              <textarea id="notes" class="textarea modern-input" rows="3" 
                        placeholder="Ej. Frutos de buen tama√±o, algunas ramas necesitan poda..."
                        maxlength="200"></textarea>
              <div class="character-counter">
                <span id="notesCounter">0</span>/200
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" id="saveBtn" class="btn btn-primary btn-large">
              <span class="btn-icon">üíæ</span>
              <span id="saveBtnText" class="btn-text">Guardar cosecha</span>
              <div class="btn-loading hidden">
                <div class="spinner"></div>
              </div>
            </button>
            
            <div class="secondary-actions">
              <button type="button" id="clearBtn" class="btn btn-outline">
                <span class="btn-icon">üßπ</span>
                Limpiar
              </button>
              <button type="button" id="previewBtn" class="btn btn-secondary hidden">
                <span class="btn-icon">üëÅÔ∏è</span>
                Vista previa
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Lista de cosechas de hoy -->
    <section class="list-section animate-on-load" style="--delay: 0.9s">
      <div class="card modern-card">
        <div class="card-header">
          <h2>üìú Cosechas de hoy</h2>
          <div class="list-controls">
            <div class="view-selector">
              <button id="viewTrees" class="view-btn active">√Årboles</button>
              <button id="viewBlocks" class="view-btn">Bloques</button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Vista por √°rboles -->
          <div id="treeView" class="table-responsive">
            <div class="table-header">
              <div class="table-cell">Hora</div>
              <div class="table-cell">√Årbol</div>
              <div class="table-cell">1¬™/2¬™/Desc</div>
              <div class="table-cell">Total</div>
              <div class="table-cell">Trabajador</div>
            </div>
            <div id="todayTreeList" class="table-body">
              <!-- Registros por √°rbol -->
            </div>
          </div>
          
          <!-- Vista por bloques -->
          <div id="blockView" class="table-responsive hidden">
            <div class="table-header">
              <div class="table-cell">Hora</div>
              <div class="table-cell">Bloque</div>
              <div class="table-cell">√Årboles</div>
              <div class="table-cell">1¬™/2¬™/Desc</div>
              <div class="table-cell">Total</div>
              <div class="table-cell">Promedio</div>
            </div>
            <div id="todayBlockList" class="table-body">
              <!-- Registros por bloque -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast notifications -->
  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <!-- Scripts Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Scripts locales -->
  <script src="js/firebase-config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/offline.js"></script>
  <script src="js/nav.js"></script>
  <script src="js/produccion.js"></script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistration().then(reg => {
        if (!reg) navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    // Animaciones de carga
    document.addEventListener('DOMContentLoaded', function() {
      const animatedElements = document.querySelectorAll('.animate-on-load');
      animatedElements.forEach((el, index) => {
        setTimeout(() => {
          el.classList.add('animate-in');
        }, index * 100);
      });
    });
  </script>
</body>
</html>
