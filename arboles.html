<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Árboles · Finca La Herradura</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#7CB342" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
</head>
<body>
  <!-- Indicador de conectividad mejorado -->
  <div id="connectivityIndicator" class="connectivity-indicator offline" aria-live="polite" role="status">
    <span class="connectivity-dot" aria-hidden="true"></span>
    <span id="connectivityText">Sin Internet</span>
    <span id="pendingBadge" class="pending-badge hidden" aria-label="Actualizaciones pendientes">0</span>
  </div>

  <main class="page trees-page">
    <!-- Header con gradiente mejorado -->
    <header class="page-header">
      <div class="header-content">
        <div class="header-text">
          <h1>🌳 Gestión de Árboles</h1>
          <p class="subtitle">Monitoreo integral de salud y productividad</p>
        </div>
        <div class="header-actions">
          <button id="syncBtn" class="btn-icon-header" aria-label="Sincronizar datos">
            <span class="icon">🔄</span>
          </button>
          <button id="mapViewBtn" class="btn-icon-header" aria-label="Vista de mapa">
            <span class="icon">🗺️</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Resumen de estados con indicadores de salud -->
    <section class="stats-section" role="region" aria-labelledby="health-stats-title">
      <h2 id="health-stats-title" class="section-title visually-hidden">Estadísticas de salud</h2>
      
      <div class="stat-card total-trees animate-on-load" style="--delay: 0.1s">
        <div class="stat-icon">🌲</div>
        <div class="stat-content">
          <div class="stat-number" id="countAll">800</div>
          <div class="stat-label">Total de árboles</div>
          <div class="stat-progress">
            <div class="progress-bar small">
              <div class="progress-fill" style="width: 100%"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="stat-card healthy-trees animate-on-load" style="--delay: 0.2s">
        <div class="stat-icon">✅</div>
        <div class="stat-content">
          <div class="stat-number" id="countSano">0</div>
          <div class="stat-label">Árboles sanos</div>
          <div class="stat-percentage" id="percentSano">0%</div>
        </div>
      </div>
      
      <div class="stat-card hlb-trees animate-on-load" style="--delay: 0.3s">
        <div class="stat-icon">🟡</div>
        <div class="stat-content">
          <div class="stat-number" id="countHLB">0</div>
          <div class="stat-label">Con HLB</div>
          <div class="stat-percentage" id="percentHLB">0%</div>
        </div>
      </div>
      
      <div class="stat-card aphid-trees animate-on-load" style="--delay: 0.4s">
        <div class="stat-icon">🟠</div>
        <div class="stat-content">
          <div class="stat-number" id="countPulgon">0</div>
          <div class="stat-label">Con pulgón</div>
          <div class="stat-percentage" id="percentPulgon">0%</div>
        </div>
      </div>
      
      <div class="stat-card sooty-trees animate-on-load" style="--delay: 0.5s">
        <div class="stat-icon">🔴</div>
        <div class="stat-content">
          <div class="stat-number" id="countFumagina">0</div>
          <div class="stat-label">Con fumagina</div>
          <div class="stat-percentage" id="percentFumagina">0%</div>
        </div>
      </div>
      
      <div class="stat-card inspection-date animate-on-load" style="--delay: 0.6s">
        <div class="stat-icon">🔍</div>
        <div class="stat-content">
          <div class="stat-number" id="lastInspection">—</div>
          <div class="stat-label">Última inspección</div>
          <div class="stat-meta" id="inspectionDays">— días</div>
        </div>
      </div>
    </section>

    <!-- Panel de salud general -->
    <section class="health-overview animate-on-load" style="--delay: 0.7s">
      <div class="card modern-card">
        <div class="card-header">
          <h2>📊 Resumen de Salud</h2>
          <div class="health-score">
            <div class="score-circle" data-score="0">
              <svg class="score-svg" viewBox="0 0 36 36">
                <path class="score-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                <path class="score-fill" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
              </svg>
              <div class="score-text">
                <span id="healthScore">0</span>
                <span class="score-unit">%</span>
              </div>
            </div>
            <div class="score-label">Salud General</div>
          </div>
        </div>
        <div class="card-body">
          <div class="health-indicators">
            <div class="health-indicator">
              <div class="indicator-header">
                <span class="indicator-title">Tendencia</span>
                <span id="healthTrend" class="trend-arrow">📈</span>
              </div>
              <div id="trendDescription" class="indicator-value">Estable</div>
            </div>
            <div class="health-indicator">
              <div class="indicator-header">
                <span class="indicator-title">Riesgo</span>
                <span id="riskLevel" class="risk-badge low">Bajo</span>
              </div>
              <div id="riskDescription" class="indicator-value">Sin plagas activas</div>
            </div>
            <div class="health-indicator">
              <div class="indicator-header">
                <span class="indicator-title">Próxima acción</span>
                <span class="action-priority normal">📅</span>
              </div>
              <div id="nextAction" class="indicator-value">Inspección rutinaria</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filtros y búsqueda mejorados -->
    <section class="form-section animate-on-load" style="--delay: 0.8s" role="region" aria-labelledby="search-filters-title">
      <div class="card modern-card">
        <div class="card-header">
          <h2 id="search-filters-title">🔍 Búsqueda y Filtros</h2>
          <div class="view-controls">
            <button id="gridViewBtn" class="view-btn active" aria-label="Vista de cuadrícula">
              <span class="icon">⊞</span>
            </button>
            <button id="listViewBtn" class="view-btn" aria-label="Vista de lista">
              <span class="icon">☰</span>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="search-controls">
            <div class="form-group-row">
              <div class="form-group">
                <label class="label" for="treeSearch">
                  <span class="label-icon">🔍</span>
                  Buscar árbol
                </label>
                <div class="search-input-wrapper">
                  <input id="treeSearch" 
                         class="input modern-input search-input" 
                         type="search" 
                         placeholder="ARB001, 123, o rango ARB100-ARB150"
                         autocomplete="off"
                         aria-describedby="search-help" />
                  <div class="search-clear hidden" id="searchClear">✕</div>
                  <div class="input-icon">🌳</div>
                </div>
                <div id="search-help" class="input-help">
                  Busca por ID específico o usa rangos
                </div>
              </div>
              
              <div class="form-group">
                <label class="label" for="stateFilter">
                  <span class="label-icon">🏥</span>
                  Estado de salud
                </label>
                <div class="select-wrapper">
                  <select id="stateFilter" class="select modern-select">
                    <option value="">Todos los estados</option>
                    <option value="sano">✅ Solo sanos</option>
                    <option value="hlb">🟡 Solo con HLB</option>
                    <option value="pulgon">🟠 Solo con pulgón</option>
                    <option value="fumagina">🔴 Solo con fumagina</option>
                    <option value="problemas">⚠️ Todos con problemas</option>
                  </select>
                  <div class="select-icon">⬇️</div>
                </div>
              </div>
            </div>

            <!-- Filtros avanzados -->
            <div class="advanced-filters">
              <button id="advancedToggle" class="filter-toggle" aria-expanded="false">
                <span class="toggle-icon">🔧</span>
                <span class="toggle-text">Filtros avanzados</span>
                <span class="toggle-arrow">▼</span>
              </button>
              
              <div id="advancedFilters" class="advanced-panel hidden">
                <div class="filter-group">
                  <label class="filter-label">Última inspección:</label>
                  <div class="filter-options">
                    <label class="filter-option">
                      <input type="radio" name="inspection" value="all" checked>
                      <span>Todas</span>
                    </label>
                    <label class="filter-option">
                      <input type="radio" name="inspection" value="recent">
                      <span>Últimos 7 días</span>
                    </label>
                    <label class="filter-option">
                      <input type="radio" name="inspection" value="pending">
                      <span>Pendientes</span>
                    </label>
                  </div>
                </div>
                
                <div class="filter-group">
                  <label class="filter-label">Productividad:</label>
                  <div class="filter-options">
                    <label class="filter-option">
                      <input type="radio" name="productivity" value="all" checked>
                      <span>Todas</span>
                    </label>
                    <label class="filter-option">
                      <input type="radio" name="productivity" value="high">
                      <span>Alta (>50/mes)</span>
                    </label>
                    <label class="filter-option">
                      <input type="radio" name="productivity" value="low">
                      <span>Baja (<20/mes)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Resumen de filtros activos -->
            <div id="activeFilters" class="active-filters hidden">
              <span class="filters-label">Filtros activos:</span>
              <div class="filter-tags" id="filterTags"></div>
              <button id="clearAllFilters" class="clear-filters">Limpiar todos</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Grid/Lista de árboles mejorado -->
    <section class="trees-display animate-on-load" style="--delay: 0.9s" role="region" aria-labelledby="trees-grid-title">
      <div class="card modern-card">
        <div class="card-header">
          <h2 id="trees-grid-title">🗺️ Mapa de Árboles</h2>
          <div class="display-info">
            <span id="displayCount" class="trees-count">800 árboles</span>
            <span id="selectedCount" class="selected-count hidden">0 seleccionados</span>
          </div>
        </div>
        <div class="card-body">
          <!-- Leyenda -->
          <div class="trees-legend">
            <div class="legend-title">Estados:</div>
            <div class="legend-items">
              <div class="legend-item">
                <span class="legend-dot healthy"></span>
                <span class="legend-text">Sano</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot hlb"></span>
                <span class="legend-text">HLB</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot aphid"></span>
                <span class="legend-text">Pulgón</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot sooty"></span>
                <span class="legend-text">Fumagina</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot unknown"></span>
                <span class="legend-text">Sin inspeccionar</span>
              </div>
            </div>
          </div>

          <!-- Vista de grid -->
          <div id="treesGridView" class="trees-container">
            <div id="treeGrid" 
                 class="tree-grid enhanced" 
                 role="grid" 
                 aria-label="Cuadrícula de árboles"
                 tabindex="0">
              <!-- Los árboles se cargarán dinámicamente -->
            </div>
            
            <div id="gridLoading" class="loading-state hidden">
              <div class="loading-spinner"></div>
              <p>Cargando árboles...</p>
            </div>
          </div>

          <!-- Vista de lista -->
          <div id="treesListView" class="trees-container hidden">
            <div class="table-responsive">
              <div class="table-header">
                <div class="table-cell">ID</div>
                <div class="table-cell">Estado</div>
                <div class="table-cell">Productividad</div>
                <div class="table-cell">Última inspección</div>
                <div class="table-cell">Acciones</div>
              </div>
              <div id="treesList" class="table-body">
                <!-- Lista se carga dinámicamente -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Panel de detalles mejorado -->
    <section class="tree-details animate-on-load" style="--delay: 1s" role="region" aria-labelledby="tree-details-title">
      <div class="card modern-card" id="treeDetailsCard">
        <div class="card-header">
          <h2 id="tree-details-title">
            <span id="panelTitle">Detalles del Árbol</span>
          </h2>
          <div class="detail-actions">
            <button id="prevTreeBtn" class="btn-nav" disabled aria-label="Árbol anterior">‹</button>
            <button id="nextTreeBtn" class="btn-nav" disabled aria-label="Árbol siguiente">›</button>
            <button id="closeDetailsBtn" class="btn-close" aria-label="Cerrar detalles">✕</button>
          </div>
        </div>
        <div class="card-body">
          <div class="tree-info-grid">
            <!-- Información básica -->
            <div class="info-section">
              <h3 class="section-title">📋 Información Básica</h3>
              <div class="info-items">
                <div class="info-item">
                  <span class="info-label">ID del árbol:</span>
                  <span id="panelId" class="info-value tree-id">—</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Estado actual:</span>
                  <span id="panelState" class="info-value tree-status">—</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Ubicación:</span>
                  <span id="panelLocation" class="info-value">—</span>
                </div>
              </div>
            </div>

            <!-- Métricas -->
            <div class="info-section">
              <h3 class="section-title">📈 Métricas</h3>
              <div class="metrics-grid">
                <div class="metric-card">
                  <div class="metric-value" id="panelProd">0</div>
                  <div class="metric-label">Unids/mes</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="panelYield">0%</div>
                  <div class="metric-label">Rendimiento</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="panelTreatments">0</div>
                  <div class="metric-label">Tratamientos</div>
                </div>
              </div>
            </div>

            <!-- Historial -->
            <div class="info-section">
              <h3 class="section-title">🕐 Historial</h3>
              <div class="info-items">
                <div class="info-item">
                  <span class="info-label">Última inspección:</span>
                  <span id="panelInspect" class="info-value">—</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Último tratamiento:</span>
                  <span id="panelLastTreatment" class="info-value">—</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Cambios de estado:</span>
                  <span id="panelStateChanges" class="info-value">—</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Actualización de estado -->
          <div class="state-update-section">
            <h3 class="section-title">🔄 Actualizar Estado</h3>
            <form id="treeUpdateForm" novalidate>
              <div class="state-selector">
                <div class="state-buttons">
                  <button type="button" data-state="sano" class="state-btn healthy">
                    <span class="state-icon">✅</span>
                    <span class="state-text">Sano</span>
                  </button>
                  <button type="button" data-state="hlb" class="state-btn hlb">
                    <span class="state-icon">🟡</span>
                    <span class="state-text">HLB</span>
                  </button>
                  <button type="button" data-state="pulgon" class="state-btn aphid">
                    <span class="state-icon">🟠</span>
                    <span class="state-text">Pulgón</span>
                  </button>
                  <button type="button" data-state="fumagina" class="state-btn sooty">
                    <span class="state-icon">🔴</span>
                    <span class="state-text">Fumagina</span>
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label class="label" for="treeNote">
                  <span class="label-icon">📝</span>
                  Observaciones de la inspección
                </label>
                <div class="textarea-wrapper">
                  <textarea id="treeNote" 
                            class="textarea modern-input" 
                            rows="3" 
                            placeholder="Ej. Hojas amarillas en sector superior, presencia de insectos..."
                            maxlength="250"
                            aria-describedby="notes-counter"></textarea>
                  <div id="notes-counter" class="character-counter">0/250</div>
                </div>
              </div>

              <!-- Subida de foto -->
              <div class="photo-section">
                <div class="form-group">
                  <label class="label" for="treePhoto">
                    <span class="label-icon">📷</span>
                    Foto del árbol o plaga
                    <span class="label-optional">(opcional)</span>
                  </label>
                  <div class="photo-upload-area">
                    <input id="treePhoto" 
                           class="photo-input" 
                           type="file" 
                           accept="image/*"
                           capture="environment"
                           aria-describedby="photo-help" />
                    <div class="upload-placeholder" id="uploadPlaceholder">
                      <div class="upload-icon">📷</div>
                      <div class="upload-text">Toca para tomar foto</div>
                      <div class="upload-subtext">JPG, PNG • Max 5MB</div>
                    </div>
                    <div class="photo-preview hidden" id="photoPreview">
                      <img id="previewImage" alt="Vista previa de la foto" />
                      <button type="button" id="removePhoto" class="remove-photo">✕</button>
                    </div>
                  </div>
                  <div id="photo-help" class="input-help">
                    La foto se subirá cuando tengas conexión a internet
                  </div>
                </div>

                <!-- Última foto -->
                <div id="lastPhotoSection" class="last-photo-section hidden">
                  <div class="last-photo-header">
                    <span class="last-photo-label">Última foto:</span>
                    <span id="lastPhotoDate" class="last-photo-date">—</span>
                  </div>
                  <div id="lastPhotoContainer" class="last-photo-container">
                    <!-- La imagen se cargará dinámicamente -->
                  </div>
                </div>
              </div>

              <!-- Botones de acción -->
              <div class="form-actions">
                <button type="submit" id="saveTreeBtn" class="btn btn-primary btn-large">
                  <span class="btn-icon">💾</span>
                  <span class="btn-text">Guardar Cambios</span>
                  <div class="btn-loading hidden">
                    <div class="spinner"></div>
                  </div>
                </button>
                
                <div class="secondary-actions">
                  <button type="button" id="uploadPhotoBtn" class="btn btn-secondary">
                    <span class="btn-icon">📤</span>
                    Subir Foto
                  </button>
                  <button type="button" id="viewHistoryBtn" class="btn btn-outline">
                    <span class="btn-icon">📊</span>
                    Historial
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast notifications -->
  <div id="toastContainer" class="toast-container" aria-live="polite"></div>

  <!-- Modal de historial del árbol -->
  <div id="historyModal" class="modal hidden" role="dialog" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-content large">
      <div class="modal-header">
        <h3 id="historyModalTitle">📊 Historial del Árbol</h3>
        <button class="modal-close" aria-label="Cerrar modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="historyContent">
          <!-- Contenido se carga dinámicamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script src="js/firebase-config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/offline.js"></script>
  <script src="js/nav.js"></script>
  <script src="js/arboles.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js', { scope: './' });
    }

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
      // Animaciones de carga
      const animatedElements = document.querySelectorAll('.animate-on-load');
      animatedElements.forEach((el, index) => {
        setTimeout(() => {
          el.classList.add('animate-in');
        }, index * 100);
      });

      // Inicializar componentes
      initializeTreesDisplay();
      initializeFilters();
      initializePhotoUpload();
      
      // Cargar datos iniciales
      loadTreesData();
      updateHealthOverview();
    });

    // Funciones auxiliares
    function initializeTreesDisplay() {
      // Configurar vistas
      const gridBtn = document.getElementById('gridViewBtn');
      const listBtn = document.getElementById('listViewBtn');
      
      gridBtn.addEventListener('click', () => switchView('grid'));
      listBtn.addEventListener('click', () => switchView('list'));
    }
    
    function switchView(view) {
      const gridView = document.getElementById('treesGridView');
      const listView = document.getElementById('treesListView');
      const gridBtn = document.getElementById('gridViewBtn');
      const listBtn = document.getElementById('listViewBtn');
      
      if (view === 'grid') {
        gridView.classList.remove('hidden');
        listView.classList.add('hidden');
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
      } else {
        gridView.classList.add('hidden');
        listView.classList.remove('hidden');
        gridBtn.classList.remove('active');
        listBtn.classList.add('active');
      }
    }
    
    function initializeFilters() {
      const advancedToggle = document.getElementById('advancedToggle');
      const advancedPanel = document.getElementById('advancedFilters');
      
      advancedToggle.addEventListener('click', function() {
        const isExpanded = this.getAttribute('aria-expanded') === 'true';
        this.setAttribute('aria-expanded', !isExpanded);
        advancedPanel.classList.toggle('hidden');
        
        const arrow = this.querySelector('.toggle-arrow');
        arrow.textContent = isExpanded ? '▼' : '▲';
      });
    }
    
    function initializePhotoUpload() {
      const photoInput = document.getElementById('treePhoto');
      const placeholder = document.getElementById('uploadPlaceholder');
      const preview = document.getElementById('photoPreview');
      
      photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('previewImage').src = e.target.result;
            placeholder.classList.add('hidden');
            preview.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });
      
      document.getElementById('removePhoto').addEventListener('click', function() {
        photoInput.value = '';
        placeholder.classList.remove('hidden');
        preview.classList.add('hidden');
      });
    }
    
    function loadTreesData() {
      // Simulación de carga de datos
      setTimeout(() => {
        updateStatsDisplay({
          total: 800,
          sano: 620,
          hlb: 85,
          pulgon: 60,
          fumagina: 35
        });
        
        updateHealthScore(77.5);
      }, 1000);
    }
    
    function updateStatsDisplay(data) {
      document.getElementById('countAll').textContent = data.total;
      document.getElementById('countSano').textContent = data.sano;
      document.getElementById('countHLB').textContent = data.hlb;
      document.getElementById('countPulgon').textContent = data.pulgon;
      document.getElementById('countFumagina').textContent = data.fumagina;
      
      // Calcular porcentajes
      const total = data.total;
      document.getElementById('percentSano').textContent = Math.round((data.sano / total) * 100) + '%';
      document.getElementById('percentHLB').textContent = Math.round((data.hlb / total) * 100) + '%';
      document.getElementById('percentPulgon').textContent = Math.round((data.pulgon / total) * 100) + '%';
      document.getElementById('percentFumagina').textContent = Math.round((data.fumagina / total) * 100) + '%';
    }
    
    function updateHealthScore(score) {
      const scoreElement = document.getElementById('healthScore');
      const scoreFill = document.querySelector('.score-fill');
      
      scoreElement.textContent = Math.round(score);
      scoreFill.setAttribute('stroke-dasharray', `${score}, 100`);
      
      // Actualizar color basado en el score
      const scoreCircle = document.querySelector('.score-circle');
      if (score >= 80) {
        scoreCircle.className = 'score-circle excellent';
      } else if (score >= 60) {
        scoreCircle.className = 'score-circle good';
      } else if (score >= 40) {
        scoreCircle.className = 'score-circle fair';
      } else {
        scoreCircle.className = 'score-circle poor';
      }
    }
    
    function updateHealthOverview() {
      // Actualizar indicadores de salud
      setTimeout(() => {
        document.getElementById('trendDescription').textContent = 'Mejorando';
        document.getElementById('riskDescription').textContent = 'Vigilar sector B';
        document.getElementById('nextAction').textContent = 'Inspección en 3 días';
      }, 1500);
    }
  </script>
</body>
</html>
